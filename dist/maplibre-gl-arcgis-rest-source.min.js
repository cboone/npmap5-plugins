!function(g,I){"object"==typeof exports&&"undefined"!=typeof module?module.exports=I():"function"==typeof define&&define.amd?define(I):(g="undefined"!=typeof globalThis?globalThis:g||self).ArcGisRestSource=I()}(this,(function(){"use strict";
/* @preserve
  * @terraformer/arcgis - v2.1.1 - MIT
  * Copyright (c) 2012-2022 Environmental Systems Research Institute, Inc.
  * Tue Aug 02 2022 14:23:48 GMT-0700 (Pacific Daylight Time)
  */var g=function(g,I,C,A){var i=(A[0]-C[0])*(g[1]-C[1])-(A[1]-C[1])*(g[0]-C[0]),e=(I[0]-g[0])*(g[1]-C[1])-(I[1]-g[1])*(g[0]-C[0]),l=(A[1]-C[1])*(I[0]-g[0])-(A[0]-C[0])*(I[1]-g[1]);if(0!==l){var Z=i/l,d=e/l;if(Z>=0&&Z<=1&&d>=0&&d<=1)return!0}return!1},I=function(I,C){for(var A=0;A<I.length-1;A++)for(var i=0;i<C.length-1;i++)if(g(I[A],I[A+1],C[i],C[i+1]))return!0;return!1},C=function(g){for(var I,C=0,A=0,i=g.length,e=g[A];A<i-1;A++)C+=((I=g[A+1])[0]-e[0])*(I[1]+e[1]),e=I;return C>=0},A=function(g,C){var A=I(g,C),i=function(g,I){for(var C=!1,A=-1,i=g.length,e=i-1;++A<i;e=A)(g[A][1]<=I[1]&&I[1]<g[e][1]||g[e][1]<=I[1]&&I[1]<g[A][1])&&I[0]<(g[e][0]-g[A][0])*(I[1]-g[A][1])/(g[e][1]-g[A][1])+g[A][0]&&(C=!C);return C}(g,C[0]);return!(A||!i)},i=function g(i,e){var l={};if(i.features){l.type="FeatureCollection",l.features=[];for(var Z=0;Z<i.features.length;Z++)l.features.push(g(i.features[Z],e))}if("number"==typeof i.x&&"number"==typeof i.y&&(l.type="Point",l.coordinates=[i.x,i.y],"number"==typeof i.z&&l.coordinates.push(i.z)),i.points&&(l.type="MultiPoint",l.coordinates=i.points.slice(0)),i.paths&&(1===i.paths.length?(l.type="LineString",l.coordinates=i.paths[0].slice(0)):(l.type="MultiLineString",l.coordinates=i.paths.slice(0))),i.rings&&(l=function(g){for(var i,e,l,Z,d=[],o=[],s=0;s<g.length;s++){var m=(function(g,I){for(var C=0;C<g.length;C++)if(g[C]!==I[C])return!1;return!0}((Z=g[s].slice(0))[0],Z[Z.length-1])||Z.push(Z[0]),Z);if(!(m.length<4))if(C(m)){var t=[m.slice().reverse()];d.push(t)}else o.push(m.slice().reverse())}for(var a=[];o.length;){l=o.pop();var c=!1;for(i=d.length-1;i>=0;i--)if(e=d[i][0],A(e,l)){d[i].push(l),c=!0;break}c||a.push(l)}for(;a.length;){l=a.pop();var n=!1;for(i=d.length-1;i>=0;i--)if(e=d[i][0],I(e,l)){d[i].push(l),n=!0;break}n||d.push([l.reverse()])}return 1===d.length?{type:"Polygon",coordinates:d[0]}:{type:"MultiPolygon",coordinates:d}}(i.rings.slice(0))),"number"==typeof i.xmin&&"number"==typeof i.ymin&&"number"==typeof i.xmax&&"number"==typeof i.ymax&&(l.type="Polygon",l.coordinates=[[[i.xmax,i.ymax],[i.xmin,i.ymax],[i.xmin,i.ymin],[i.xmax,i.ymin],[i.xmax,i.ymax]]]),(i.geometry||i.attributes)&&(l.type="Feature",l.geometry=i.geometry?g(i.geometry):null,l.properties=i.attributes?function(g){var I={};for(var C in g)g.hasOwnProperty(C)&&(I[C]=g[C]);return I}(i.attributes):null,i.attributes))try{l.id=function(g,I){for(var C=I?[I,"OBJECTID","FID"]:["OBJECTID","FID"],A=0;A<C.length;A++){var i=C[A];if(i in g&&("string"==typeof g[i]||"number"==typeof g[i]))return g[i]}throw Error("No valid id attribute found")}(i.attributes,e)}catch(g){}return JSON.stringify(l.geometry)===JSON.stringify({})&&(l.geometry=null),i.spatialReference&&i.spatialReference.wkid&&4326!==i.spatialReference.wkid&&console.warn("Object converted in non-standard crs - "+JSON.stringify(i.spatialReference)),l},e=null;try{var l="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");e=l.Worker}catch(g){}function Z(g,I,C){var A=void 0===I?null:I,i=function(g,I){return Buffer.from(g,"base64").toString(I?"utf16":"utf8")}(g,void 0!==C&&C),l=i.indexOf("\n",10)+1,Z=i.substring(l)+(A?"//# sourceMappingURL="+A:"");return function(g){return new e(Z,Object.assign({},g,{eval:!0}))}}function d(g,I,C){var A=void 0===I?null:I,i=function(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),i=0,e=C.length;i<e;++i)A[i]=C.charCodeAt(i);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(g,void 0!==C&&C),e=i.indexOf("\n",10)+1,l=i.substring(e)+(A?"//# sourceMappingURL="+A:""),Z=new Blob([l],{type:"application/javascript"});return URL.createObjectURL(Z)}var o="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var s,m,t,a=(s="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGUgPSAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAndXNlIHN0cmljdCc7CgogIGNvbnN0IGVhcnRoQ2lyY3VtZmVyZW5jZSA9IDQwMDc1MDE2LjY4NTU3ODQ5Ow0KICAvKioNCiAgICAqIENvbnZlcnRzIGEgd2VibWVyY2F0b3IgeCx5IHRvIFdHUzg0IGxuZyxsYXQNCiAgICAqIEBwYXJhbSB4DQogICAgKiBAcGFyYW0geQ0KICAgICogQHJldHVybnMgTG5nTG5nTGlrZQ0KICAgICovDQogIGZ1bmN0aW9uIHRvV0dTODQoeCwgeSkgew0KICAgICAgLy8gQ29udmVydCB0aGUgbGF0IGxuZw0KICAgICAgY29uc3Qgd2dzTG5nID0geCAqIDE4MCAvIChlYXJ0aENpcmN1bWZlcmVuY2UgLyAyKTsNCiAgICAgIC8vIHRoYW5rcyBtYWdpY2hpbSBAIGdpdGh1YiBmb3IgdGhlIGNvcnJlY3Rpb24NCiAgICAgIGNvbnN0IHdnc0xhdCA9IE1hdGguYXRhbihNYXRoLmV4cCh5ICogTWF0aC5QSSAvIChlYXJ0aENpcmN1bWZlcmVuY2UgLyAyKSkpICogMzYwIC8gTWF0aC5QSSAtIDkwOw0KICAgICAgcmV0dXJuIHsgbG5nOiB3Z3NMbmcsIGxhdDogd2dzTGF0IH07DQogIH0KCiAgY29uc3Qgd2ViTWVyY2F0b3JDb2RlcyA9IFsnMTAyMTAwJywgJzkwMDkxMycsICczODU3JywgJzM1ODcnLCAnNTQwMDQnLCAnNDEwMDEnLCAnMTAyMTEzJywgJzM3ODUnXTsNCiAgZnVuY3Rpb24gbWVyZ2VSaW5ncyhyaW5nc1gsIHJpbmdzWSwgc3JpZCkgew0KICAgICAgY29uc3QgcmVwcm9qZWN0ID0gKHgsIHkpID0+IHsNCiAgICAgICAgICBjb25zdCB4eSA9IHRvV0dTODQoeCwgeSk7DQogICAgICAgICAgcmV0dXJuIFt4eS5sbmcsIHh5LmxhdF07DQogICAgICB9Ow0KICAgICAgaWYgKHdlYk1lcmNhdG9yQ29kZXMuaW5kZXhPZihzcmlkKSA+IC0xKSB7DQogICAgICAgICAgcmV0dXJuIHJpbmdzWC5tYXAoKHJpbmcsIGkpID0+IHJpbmcubWFwKCh4LCBqKSA9PiByZXByb2plY3QoeCwgcmluZ3NZW2ldW2pdKSkpOw0KICAgICAgfQ0KICAgICAgZWxzZSB7DQogICAgICAgICAgcmV0dXJuIHJpbmdzWC5tYXAoKHJpbmcsIGkpID0+IHJpbmcubWFwKCh4LCBqKSA9PiBbeCwgcmluZ3NZW2ldW2pdXSkpOw0KICAgICAgfQ0KICB9DQogIGZ1bmN0aW9uIGRlWmlnWmFnKHZhbHVlcywgc3BsaXRzLCBzY2FsZSwgaW5pdGlhbE9mZnNldCwgdXBwZXJMZWZ0T3JpZ2luKSB7DQogICAgICByZXR1cm4gc3BsaXRzLm1hcCgoc3BsaXQsIGkpID0+IHsNCiAgICAgICAgICBsZXQgbGFzdFZhbHVlID0gMDsNCiAgICAgICAgICByZXR1cm4gQXJyYXkoc3BsaXQpLmZpbGwodW5kZWZpbmVkKS5tYXAoKF8sIGopID0+IHsNCiAgICAgICAgICAgICAgY29uc3QgdmFsdWVPZmZzZXQgPSBzcGxpdHMucmVkdWNlKChhLCB2LCBpZHgpID0+IGEgKz0gKGlkeCA8IGkgPyB2IDogMCksIDApOw0KICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHZhbHVlc1t2YWx1ZU9mZnNldCArIGpdOw0KICAgICAgICAgICAgICBjb25zdCBzaWduID0gdXBwZXJMZWZ0T3JpZ2luID8gLTEgOiAxOw0KICAgICAgICAgICAgICBsZXQgcmV0dXJuVmFsdWU7DQogICAgICAgICAgICAgIGlmIChqID09PSAwKSB7DQogICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZSA9ICh2YWx1ZSAqIHNpZ24pICsgKGluaXRpYWxPZmZzZXQgLyBzY2FsZSk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZSA9ICh2YWx1ZSAqIHNpZ24pICsgbGFzdFZhbHVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IHJldHVyblZhbHVlOw0KICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7DQogICAgICAgICAgfSkubWFwKCh2KSA9PiB2ICogc2NhbGUpOw0KICAgICAgfSk7DQogIH0NCiAgY2xhc3MgRGVaaWdaYWdKU09OIHsNCiAgICAgIGNvbnN0cnVjdG9yKGZlYXR1cmVzLCB0cmFuc2Zvcm0sIGdlb21ldHJ5VHlwZSkgew0KICAgICAgICAgIHRoaXMuc3JpZCA9ICczODU3JzsNCiAgICAgICAgICB0aGlzLmZlYXR1cmVzID0gZmVhdHVyZXM7DQogICAgICAgICAgdGhpcy50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07DQogICAgICAgICAgdGhpcy5nZW9tZXRyeVR5cGUgPSBnZW9tZXRyeVR5cGU7DQogICAgICB9DQogICAgICBhc3luYyBjb252ZXJ0KCkgew0KICAgICAgICAgIHJldHVybiB0aGlzLmZlYXR1cmVzLm1hcChmZWF0dXJlID0+IHsNCiAgICAgICAgICAgICAgZmVhdHVyZS5nZW9tZXRyeSA9IHRoaXMuY29udmVydEdlb21ldHJ5KGZlYXR1cmUuZ2VvbWV0cnkpOw0KICAgICAgICAgICAgICByZXR1cm4gZmVhdHVyZTsNCiAgICAgICAgICB9KTsNCiAgICAgIH0NCiAgICAgIGNvbnZlcnRHZW9tZXRyeShnZW9tZXRyeSkgew0KICAgICAgICAgIGNvbnN0IGNvdW50cyA9IFtdOw0KICAgICAgICAgIGNvbnN0IHggPSBbXTsNCiAgICAgICAgICBjb25zdCB5ID0gW107DQogICAgICAgICAgaWYgKHRoaXMuZ2VvbWV0cnlUeXBlID09PSAnZXNyaUdlb21ldHJ5UG9pbnQnKSB7DQogICAgICAgICAgICAgIGNvdW50cy5wdXNoKDEpOw0KICAgICAgICAgICAgICB4LnB1c2goZ2VvbWV0cnkueCk7DQogICAgICAgICAgICAgIHkucHVzaChnZW9tZXRyeS55KTsNCiAgICAgICAgICB9DQogICAgICAgICAgZWxzZSBpZiAodGhpcy5nZW9tZXRyeVR5cGUgPT09ICdlc3JpR2VvbWV0cnlNdWx0aXBvaW50Jykgew0KICAgICAgICAgICAgICBnZW9tZXRyeS5wb2ludHMuZm9yRWFjaChwID0+IHsNCiAgICAgICAgICAgICAgICAgIGNvdW50cy5wdXNoKDEpOw0KICAgICAgICAgICAgICAgICAgeC5wdXNoKHBbMF0pOw0KICAgICAgICAgICAgICAgICAgeS5wdXNoKHBbMV0pOw0KICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICB9DQogICAgICAgICAgZWxzZSBpZiAodGhpcy5nZW9tZXRyeVR5cGUgPT09ICdlc3JpR2VvbWV0cnlQb2x5bGluZScpIHsNCiAgICAgICAgICAgICAgZ2VvbWV0cnkucGF0aHMuZm9yRWFjaChsID0+IHsNCiAgICAgICAgICAgICAgICAgIGNvdW50cy5wdXNoKGwubGVuZ3RoKTsNCiAgICAgICAgICAgICAgICAgIGwuZm9yRWFjaChwb3NpdGlvbiA9PiB7DQogICAgICAgICAgICAgICAgICAgICAgeC5wdXNoKHBvc2l0aW9uWzBdKTsNCiAgICAgICAgICAgICAgICAgICAgICB5LnB1c2gocG9zaXRpb25bMV0pOw0KICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0NCiAgICAgICAgICBlbHNlIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeVBvbHlnb24nKSB7DQogICAgICAgICAgICAgIGdlb21ldHJ5LnJpbmdzLmZvckVhY2gocG9seSA9PiB7DQogICAgICAgICAgICAgICAgICBjb3VudHMucHVzaChwb2x5Lmxlbmd0aCk7DQogICAgICAgICAgICAgICAgICBwb2x5LmZvckVhY2gocG9zaXRpb24gPT4gew0KICAgICAgICAgICAgICAgICAgICAgIHgucHVzaChwb3NpdGlvblswXSk7DQogICAgICAgICAgICAgICAgICAgICAgeS5wdXNoKHBvc2l0aW9uWzFdKTsNCiAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICB9DQogICAgICAgICAgLy8gZGV6aWd6YWcgdGhlIHJpbmdzLCBhbmQgbWVyZ2UgKyByZXByb2plY3QgdGhlbQ0KICAgICAgICAgIGNvbnN0IHJpbmdzWCA9IGRlWmlnWmFnKHgsIGNvdW50cywgdGhpcy50cmFuc2Zvcm0uc2NhbGVbMF0sIHRoaXMudHJhbnNmb3JtLnRyYW5zbGF0ZVswXSwgZmFsc2UpOw0KICAgICAgICAgIGNvbnN0IHJpbmdzWSA9IGRlWmlnWmFnKHksIGNvdW50cywgdGhpcy50cmFuc2Zvcm0uc2NhbGVbMV0sIHRoaXMudHJhbnNmb3JtLnRyYW5zbGF0ZVsxXSwgdGhpcy50cmFuc2Zvcm0ub3JpZ2luUG9zaXRpb24gPT09ICd1cHBlckxlZnQnKTsNCiAgICAgICAgICAvLyBNZXJnZSB0aGUgcmluZ3MNCiAgICAgICAgICBjb25zdCByaW5ncyA9IG1lcmdlUmluZ3MocmluZ3NYLCByaW5nc1ksIHRoaXMuc3JpZCk7DQogICAgICAgICAgbGV0IG5ld0dlb21ldHJ5ID0ge307DQogICAgICAgICAgaWYgKHRoaXMuZ2VvbWV0cnlUeXBlID09PSAnZXNyaUdlb21ldHJ5UG9pbnQnKSB7DQogICAgICAgICAgICAgIG5ld0dlb21ldHJ5ID0geyAneCc6IHJpbmdzWzBdWzBdWzBdLCAneSc6IHJpbmdzWzBdWzBdWzFdIH07DQogICAgICAgICAgfQ0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2VvbWV0cnlUeXBlID09PSAnZXNyaUdlb21ldHJ5TXVsdGlwb2ludCcpIHsNCiAgICAgICAgICAgICAgbmV3R2VvbWV0cnkgPSB7ICdwb2ludHMnOiByaW5nc1swXSB9Ow0KICAgICAgICAgIH0NCiAgICAgICAgICBlbHNlIGlmICh0aGlzLmdlb21ldHJ5VHlwZSA9PT0gJ2VzcmlHZW9tZXRyeVBvbHlsaW5lJykgew0KICAgICAgICAgICAgICBuZXdHZW9tZXRyeSA9IHsgcGF0aHM6IHJpbmdzIH07DQogICAgICAgICAgfQ0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZ2VvbWV0cnlUeXBlID09PSAnZXNyaUdlb21ldHJ5UG9seWdvbicpIHsNCiAgICAgICAgICAgICAgbmV3R2VvbWV0cnkgPSB7IHJpbmdzOiByaW5ncyB9Ow0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gbmV3R2VvbWV0cnk7DQogICAgICB9DQogIH0KCiAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgZnVuY3Rpb24gcHJvdG8gKCkgew0KICAgICAgbGV0IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlciA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLl9yZWFkRmllbGQsIHsgdmVyc2lvbjogIiIsIHF1ZXJ5UmVzdWx0OiBudWxsIH0sIGVuZCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai52ZXJzaW9uID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpDQogICAgICAgICAgICAgIG9iai5xdWVyeVJlc3VsdCA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdC5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgew0KICAgICAgICAgIGlmIChvYmoudmVyc2lvbikNCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoMSwgb2JqLnZlcnNpb24pOw0KICAgICAgICAgIGlmIChvYmoucXVlcnlSZXN1bHQpDQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMiwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0LndyaXRlLCBvYmoucXVlcnlSZXN1bHQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVR5cGUgPSB7DQogICAgICAgICAgImVzcmlHZW9tZXRyeVR5cGVQb2ludCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMCwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImVzcmlHZW9tZXRyeVR5cGVNdWx0aXBvaW50Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUdlb21ldHJ5VHlwZVBvbHlsaW5lIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAyLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUdlb21ldHJ5VHlwZVBvbHlnb24iOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDMsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJlc3JpR2VvbWV0cnlUeXBlTXVsdGlwYXRjaCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogNCwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImVzcmlHZW9tZXRyeVR5cGVOb25lIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxMjcsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkVHlwZSA9IHsNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZVNtYWxsSW50ZWdlciI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMCwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImVzcmlGaWVsZFR5cGVJbnRlZ2VyIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZVNpbmdsZSI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMiwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImVzcmlGaWVsZFR5cGVEb3VibGUiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDMsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJlc3JpRmllbGRUeXBlU3RyaW5nIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiA0LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZURhdGUiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDUsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJlc3JpRmllbGRUeXBlT0lEIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiA2LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUdlb21ldHJ5Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiA3LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUJsb2IiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDgsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJlc3JpRmllbGRUeXBlUmFzdGVyIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiA5LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUdVSUQiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDEwLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAiZXNyaUZpZWxkVHlwZUdsb2JhbElEIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxMSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImVzcmlGaWVsZFR5cGVYTUwiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDEyLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TUUxUeXBlID0gew0KICAgICAgICAgICJzcWxUeXBlQmlnSW50Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiAwLA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZUJpbmFyeSI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVCaXQiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDIsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlQ2hhciI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMywNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVEYXRlIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiA0LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZURlY2ltYWwiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDUsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlRG91YmxlIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiA2LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZUZsb2F0Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiA3LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZUdlb21ldHJ5Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiA4LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZUdVSUQiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDksDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlSW50ZWdlciI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMTAsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlTG9uZ05WYXJjaGFyIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxMSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVMb25nVmFyYmluYXJ5Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxMiwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVMb25nVmFyY2hhciI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMTMsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlTkNoYXIiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDE0LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZU5WYXJjaGFyIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAxNSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVPdGhlciI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMTYsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlUmVhbCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMTcsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlU21hbGxJbnQiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDE4LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZVNxbFhtbCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMTksDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlVGltZSI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMjAsDQogICAgICAgICAgICAgICJvcHRpb25zIjoge30NCiAgICAgICAgICB9LA0KICAgICAgICAgICJzcWxUeXBlVGltZXN0YW1wIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAyMSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVUaW1lc3RhbXAyIjogew0KICAgICAgICAgICAgICAidmFsdWUiOiAyMiwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVUaW55SW50Ijogew0KICAgICAgICAgICAgICAidmFsdWUiOiAyMywNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgInNxbFR5cGVWYXJiaW5hcnkiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDI0LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfSwNCiAgICAgICAgICAic3FsVHlwZVZhcmNoYXIiOiB7DQogICAgICAgICAgICAgICJ2YWx1ZSI6IDI1LA0KICAgICAgICAgICAgICAib3B0aW9ucyI6IHt9DQogICAgICAgICAgfQ0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWFudGl6ZU9yaWdpblBvc3Rpb24gPSB7DQogICAgICAgICAgInVwcGVyTGVmdCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMCwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0sDQogICAgICAgICAgImxvd2VyTGVmdCI6IHsNCiAgICAgICAgICAgICAgInZhbHVlIjogMSwNCiAgICAgICAgICAgICAgIm9wdGlvbnMiOiB7fQ0KICAgICAgICAgIH0NCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZSA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZS5fcmVhZEZpZWxkLCB7IHdraWQ6IDAsIGxhc3Rlc3RXa2lkOiAwLCB2Y3NXa2lkOiAwLCBsYXRlc3RWY3NXa2lkOiAwLCB3a3Q6ICIiIH0sIGVuZCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gMSkNCiAgICAgICAgICAgICAgb2JqLndraWQgPSBwYmYucmVhZFZhcmludCgpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLmxhc3Rlc3RXa2lkID0gcGJmLnJlYWRWYXJpbnQoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai52Y3NXa2lkID0gcGJmLnJlYWRWYXJpbnQoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpDQogICAgICAgICAgICAgIG9iai5sYXRlc3RWY3NXa2lkID0gcGJmLnJlYWRWYXJpbnQoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDUpDQogICAgICAgICAgICAgIG9iai53a3QgPSBwYmYucmVhZFN0cmluZygpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TcGF0aWFsUmVmZXJlbmNlLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai53a2lkKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgxLCBvYmoud2tpZCk7DQogICAgICAgICAgaWYgKG9iai5sYXN0ZXN0V2tpZCkNCiAgICAgICAgICAgICAgcGJmLndyaXRlVmFyaW50RmllbGQoMiwgb2JqLmxhc3Rlc3RXa2lkKTsNCiAgICAgICAgICBpZiAob2JqLnZjc1draWQpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDMsIG9iai52Y3NXa2lkKTsNCiAgICAgICAgICBpZiAob2JqLmxhdGVzdFZjc1draWQpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDQsIG9iai5sYXRlc3RWY3NXa2lkKTsNCiAgICAgICAgICBpZiAob2JqLndrdCkNCiAgICAgICAgICAgICAgcGJmLndyaXRlU3RyaW5nRmllbGQoNSwgb2JqLndrdCk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GaWVsZCA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLl9yZWFkRmllbGQsIHsgbmFtZTogIiIsIGZpZWxkVHlwZTogMCwgYWxpYXM6ICIiLCBzcWxUeXBlOiAwLCBkb21haW46ICIiLCBkZWZhdWx0VmFsdWU6ICIiIH0sIGVuZCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai5uYW1lID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpDQogICAgICAgICAgICAgIG9iai5maWVsZFR5cGUgPSBwYmYucmVhZFZhcmludCgpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMykNCiAgICAgICAgICAgICAgb2JqLmFsaWFzID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpDQogICAgICAgICAgICAgIG9iai5zcWxUeXBlID0gcGJmLnJlYWRWYXJpbnQoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDUpDQogICAgICAgICAgICAgIG9iai5kb21haW4gPSBwYmYucmVhZFN0cmluZygpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNikNCiAgICAgICAgICAgICAgb2JqLmRlZmF1bHRWYWx1ZSA9IHBiZi5yZWFkU3RyaW5nKCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai5uYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmoubmFtZSk7DQogICAgICAgICAgaWYgKG9iai5maWVsZFR5cGUpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDIsIG9iai5maWVsZFR5cGUpOw0KICAgICAgICAgIGlmIChvYmouYWxpYXMpDQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDMsIG9iai5hbGlhcyk7DQogICAgICAgICAgaWYgKG9iai5zcWxUeXBlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCg0LCBvYmouc3FsVHlwZSk7DQogICAgICAgICAgaWYgKG9iai5kb21haW4pDQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDUsIG9iai5kb21haW4pOw0KICAgICAgICAgIGlmIChvYmouZGVmYXVsdFZhbHVlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCg2LCBvYmouZGVmYXVsdFZhbHVlKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlZhbHVlID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUuX3JlYWRGaWVsZCwgeyBzdHJpbmdfdmFsdWU6ICIiLCB2YWx1ZV90eXBlOiBudWxsLCBmbG9hdF92YWx1ZTogMCwgZG91YmxlX3ZhbHVlOiAwLCBzaW50X3ZhbHVlOiAwLCB1aW50X3ZhbHVlOiAwLCBpbnQ2NF92YWx1ZTogMCwgdWludDY0X3ZhbHVlOiAwLCBzaW50NjRfdmFsdWU6IDAsIGJvb2xfdmFsdWU6IGZhbHNlIH0sIGVuZCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlZhbHVlLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai5zdHJpbmdfdmFsdWUgPSBwYmYucmVhZFN0cmluZygpLCBvYmoudmFsdWVfdHlwZSA9ICJzdHJpbmdfdmFsdWUiOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLmZsb2F0X3ZhbHVlID0gcGJmLnJlYWRGbG9hdCgpLCBvYmoudmFsdWVfdHlwZSA9ICJmbG9hdF92YWx1ZSI7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQ0KICAgICAgICAgICAgICBvYmouZG91YmxlX3ZhbHVlID0gcGJmLnJlYWREb3VibGUoKSwgb2JqLnZhbHVlX3R5cGUgPSAiZG91YmxlX3ZhbHVlIjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpDQogICAgICAgICAgICAgIG9iai5zaW50X3ZhbHVlID0gcGJmLnJlYWRTVmFyaW50KCksIG9iai52YWx1ZV90eXBlID0gInNpbnRfdmFsdWUiOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNSkNCiAgICAgICAgICAgICAgb2JqLnVpbnRfdmFsdWUgPSBwYmYucmVhZFZhcmludCgpLCBvYmoudmFsdWVfdHlwZSA9ICJ1aW50X3ZhbHVlIjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDYpDQogICAgICAgICAgICAgIG9iai5pbnQ2NF92YWx1ZSA9IHBiZi5yZWFkVmFyaW50KHRydWUpLCBvYmoudmFsdWVfdHlwZSA9ICJpbnQ2NF92YWx1ZSI7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA3KQ0KICAgICAgICAgICAgICBvYmoudWludDY0X3ZhbHVlID0gcGJmLnJlYWRWYXJpbnQoKSwgb2JqLnZhbHVlX3R5cGUgPSAidWludDY0X3ZhbHVlIjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDgpDQogICAgICAgICAgICAgIG9iai5zaW50NjRfdmFsdWUgPSBwYmYucmVhZFNWYXJpbnQoKSwgb2JqLnZhbHVlX3R5cGUgPSAic2ludDY0X3ZhbHVlIjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDkpDQogICAgICAgICAgICAgIG9iai5ib29sX3ZhbHVlID0gcGJmLnJlYWRCb29sZWFuKCksIG9iai52YWx1ZV90eXBlID0gImJvb2xfdmFsdWUiOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZS53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgew0KICAgICAgICAgIGlmIChvYmouc3RyaW5nX3ZhbHVlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmouc3RyaW5nX3ZhbHVlKTsNCiAgICAgICAgICBpZiAob2JqLmZsb2F0X3ZhbHVlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVGbG9hdEZpZWxkKDIsIG9iai5mbG9hdF92YWx1ZSk7DQogICAgICAgICAgaWYgKG9iai5kb3VibGVfdmFsdWUpDQogICAgICAgICAgICAgIHBiZi53cml0ZURvdWJsZUZpZWxkKDMsIG9iai5kb3VibGVfdmFsdWUpOw0KICAgICAgICAgIGlmIChvYmouc2ludF92YWx1ZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlU1ZhcmludEZpZWxkKDQsIG9iai5zaW50X3ZhbHVlKTsNCiAgICAgICAgICBpZiAob2JqLnVpbnRfdmFsdWUpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDUsIG9iai51aW50X3ZhbHVlKTsNCiAgICAgICAgICBpZiAob2JqLmludDY0X3ZhbHVlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCg2LCBvYmouaW50NjRfdmFsdWUpOw0KICAgICAgICAgIGlmIChvYmoudWludDY0X3ZhbHVlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCg3LCBvYmoudWludDY0X3ZhbHVlKTsNCiAgICAgICAgICBpZiAob2JqLnNpbnQ2NF92YWx1ZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlU1ZhcmludEZpZWxkKDgsIG9iai5zaW50NjRfdmFsdWUpOw0KICAgICAgICAgIGlmIChvYmouYm9vbF92YWx1ZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlQm9vbGVhbkZpZWxkKDksIG9iai5ib29sX3ZhbHVlKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnkgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5ID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnkucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnkuX3JlYWRGaWVsZCwgeyBsZW5ndGhzOiBbXSwgY29vcmRzOiBbXSB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeS5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAodGFnID09PSAyKQ0KICAgICAgICAgICAgICBwYmYucmVhZFBhY2tlZFZhcmludChvYmoubGVuZ3Rocyk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAzKQ0KICAgICAgICAgICAgICBwYmYucmVhZFBhY2tlZFNWYXJpbnQob2JqLmNvb3Jkcyk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai5sZW5ndGhzKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVQYWNrZWRWYXJpbnQoMiwgb2JqLmxlbmd0aHMpOw0KICAgICAgICAgIGlmIChvYmouY29vcmRzKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVQYWNrZWRTVmFyaW50KDMsIG9iai5jb29yZHMpOw0KICAgICAgfTsNCiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLmVzcmlTaGFwZUJ1ZmZlciA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLmVzcmlTaGFwZUJ1ZmZlci5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7DQogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIuX3JlYWRGaWVsZCwgeyBieXRlczogbnVsbCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gMSkNCiAgICAgICAgICAgICAgb2JqLmJ5dGVzID0gcGJmLnJlYWRCeXRlcygpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLmJ5dGVzKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVCeXRlc0ZpZWxkKDEsIG9iai5ieXRlcyk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmUgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmUgPSB7fTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmUuX3JlYWRGaWVsZCwgeyBhdHRyaWJ1dGVzOiBbXSwgZ2VvbWV0cnk6IG51bGwsIGNvbXByZXNzZWRfZ2VvbWV0cnk6IG51bGwsIHNoYXBlQnVmZmVyOiBudWxsLCBjZW50cm9pZDogbnVsbCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai5hdHRyaWJ1dGVzLnB1c2goRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlZhbHVlLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcykpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLmdlb21ldHJ5ID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyksIG9iai5jb21wcmVzc2VkX2dlb21ldHJ5ID0gImdlb21ldHJ5IjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai5zaGFwZUJ1ZmZlciA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5lc3JpU2hhcGVCdWZmZXIucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSwgb2JqLmNvbXByZXNzZWRfZ2VvbWV0cnkgPSAic2hhcGVCdWZmZXIiOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gNCkNCiAgICAgICAgICAgICAgb2JqLmNlbnRyb2lkID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmUud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLmF0dHJpYnV0ZXMpDQogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspDQogICAgICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDEsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5WYWx1ZS53cml0ZSwgb2JqLmF0dHJpYnV0ZXNbaV0pOw0KICAgICAgICAgIGlmIChvYmouZ2VvbWV0cnkpDQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMiwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5LndyaXRlLCBvYmouZ2VvbWV0cnkpOw0KICAgICAgICAgIGlmIChvYmouc2hhcGVCdWZmZXIpDQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMywgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLmVzcmlTaGFwZUJ1ZmZlci53cml0ZSwgb2JqLnNoYXBlQnVmZmVyKTsNCiAgICAgICAgICBpZiAob2JqLmNlbnRyb2lkKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDQsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeS53cml0ZSwgb2JqLmNlbnRyb2lkKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZCA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZCA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlVuaXF1ZUlkRmllbGQucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC5fcmVhZEZpZWxkLCB7IG5hbWU6ICIiLCBpc1N5c3RlbU1haW50YWluZWQ6IGZhbHNlIH0sIGVuZCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlVuaXF1ZUlkRmllbGQuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gMSkNCiAgICAgICAgICAgICAgb2JqLm5hbWUgPSBwYmYucmVhZFN0cmluZygpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLmlzU3lzdGVtTWFpbnRhaW5lZCA9IHBiZi5yZWFkQm9vbGVhbigpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5VbmlxdWVJZEZpZWxkLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai5uYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmoubmFtZSk7DQogICAgICAgICAgaWYgKG9iai5pc1N5c3RlbU1haW50YWluZWQpDQogICAgICAgICAgICAgIHBiZi53cml0ZUJvb2xlYW5GaWVsZCgyLCBvYmouaXNTeXN0ZW1NYWludGFpbmVkKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnlQcm9wZXJ0aWVzID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVByb3BlcnRpZXMgPSB7fTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5HZW9tZXRyeVByb3BlcnRpZXMucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnlQcm9wZXJ0aWVzLl9yZWFkRmllbGQsIHsgc2hhcGVBcmVhRmllbGROYW1lOiAiIiwgc2hhcGVMZW5ndGhGaWVsZE5hbWU6ICIiLCB1bml0czogIiIgfSwgZW5kKTsNCiAgICAgIH07DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnlQcm9wZXJ0aWVzLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai5zaGFwZUFyZWFGaWVsZE5hbWUgPSBwYmYucmVhZFN0cmluZygpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLnNoYXBlTGVuZ3RoRmllbGROYW1lID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai51bml0cyA9IHBiZi5yZWFkU3RyaW5nKCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcy53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgew0KICAgICAgICAgIGlmIChvYmouc2hhcGVBcmVhRmllbGROYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmouc2hhcGVBcmVhRmllbGROYW1lKTsNCiAgICAgICAgICBpZiAob2JqLnNoYXBlTGVuZ3RoRmllbGROYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgyLCBvYmouc2hhcGVMZW5ndGhGaWVsZE5hbWUpOw0KICAgICAgICAgIGlmIChvYmoudW5pdHMpDQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDMsIG9iai51bml0cyk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMgPSB7fTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMuX3JlYWRGaWVsZCwgeyBtaW5TZXJ2ZXJHZW46IDAsIHNlcnZlckdlbjogMCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai5taW5TZXJ2ZXJHZW4gPSBwYmYucmVhZFZhcmludCgpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLnNlcnZlckdlbiA9IHBiZi5yZWFkVmFyaW50KCk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLm1pblNlcnZlckdlbikNCiAgICAgICAgICAgICAgcGJmLndyaXRlVmFyaW50RmllbGQoMSwgb2JqLm1pblNlcnZlckdlbik7DQogICAgICAgICAgaWYgKG9iai5zZXJ2ZXJHZW4pDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDIsIG9iai5zZXJ2ZXJHZW4pOw0KICAgICAgfTsNCiAgICAgIC8vIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2NhbGUgPSB7fTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS5yZWFkID0gZnVuY3Rpb24gKHBiZiwgZW5kKSB7DQogICAgICAgICAgcmV0dXJuIHBiZi5yZWFkRmllbGRzKEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS5fcmVhZEZpZWxkLCB7IHhTY2FsZTogMCwgeVNjYWxlOiAwLCBtU2NhbGU6IDAsIHpTY2FsZTogMCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAodGFnID09PSAxKQ0KICAgICAgICAgICAgICBvYmoueFNjYWxlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpDQogICAgICAgICAgICAgIG9iai55U2NhbGUgPSBwYmYucmVhZERvdWJsZSgpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMykNCiAgICAgICAgICAgICAgb2JqLm1TY2FsZSA9IHBiZi5yZWFkRG91YmxlKCk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA0KQ0KICAgICAgICAgICAgICBvYmouelNjYWxlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgIH07DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2NhbGUud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLnhTY2FsZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlRG91YmxlRmllbGQoMSwgb2JqLnhTY2FsZSk7DQogICAgICAgICAgaWYgKG9iai55U2NhbGUpDQogICAgICAgICAgICAgIHBiZi53cml0ZURvdWJsZUZpZWxkKDIsIG9iai55U2NhbGUpOw0KICAgICAgICAgIGlmIChvYmoubVNjYWxlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgzLCBvYmoubVNjYWxlKTsNCiAgICAgICAgICBpZiAob2JqLnpTY2FsZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlRG91YmxlRmllbGQoNCwgb2JqLnpTY2FsZSk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zbGF0ZSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zbGF0ZS5fcmVhZEZpZWxkLCB7IHhUcmFuc2xhdGU6IDAsIHlUcmFuc2xhdGU6IDAsIG1UcmFuc2xhdGU6IDAsIHpUcmFuc2xhdGU6IDAgfSwgZW5kKTsNCiAgICAgIH07DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlLl9yZWFkRmllbGQgPSBmdW5jdGlvbiAodGFnLCBvYmosIHBiZikgew0KICAgICAgICAgIGlmICh0YWcgPT09IDEpDQogICAgICAgICAgICAgIG9iai54VHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpDQogICAgICAgICAgICAgIG9iai55VHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai5tVHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpDQogICAgICAgICAgICAgIG9iai56VHJhbnNsYXRlID0gcGJmLnJlYWREb3VibGUoKTsNCiAgICAgIH07DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlLndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai54VHJhbnNsYXRlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgxLCBvYmoueFRyYW5zbGF0ZSk7DQogICAgICAgICAgaWYgKG9iai55VHJhbnNsYXRlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgyLCBvYmoueVRyYW5zbGF0ZSk7DQogICAgICAgICAgaWYgKG9iai5tVHJhbnNsYXRlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCgzLCBvYmoubVRyYW5zbGF0ZSk7DQogICAgICAgICAgaWYgKG9iai56VHJhbnNsYXRlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVEb3VibGVGaWVsZCg0LCBvYmouelRyYW5zbGF0ZSk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtLnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybS5fcmVhZEZpZWxkLCB7IHF1YW50aXplT3JpZ2luUG9zdGlvbjogMCwgc2NhbGU6IG51bGwsIHRyYW5zbGF0ZTogbnVsbCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2Zvcm0uX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gMSkNCiAgICAgICAgICAgICAgb2JqLnF1YW50aXplT3JpZ2luUG9zdGlvbiA9IHBiZi5yZWFkVmFyaW50KCk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAyKQ0KICAgICAgICAgICAgICBvYmouc2NhbGUgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2NhbGUucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai50cmFuc2xhdGUgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlRyYW5zZm9ybS53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgew0KICAgICAgICAgIGlmIChvYmoucXVhbnRpemVPcmlnaW5Qb3N0aW9uKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVWYXJpbnRGaWVsZCgxLCBvYmoucXVhbnRpemVPcmlnaW5Qb3N0aW9uKTsNCiAgICAgICAgICBpZiAob2JqLnNjYWxlKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDIsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TY2FsZS53cml0ZSwgb2JqLnNjYWxlKTsNCiAgICAgICAgICBpZiAob2JqLnRyYW5zbGF0ZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgzLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNsYXRlLndyaXRlLCBvYmoudHJhbnNsYXRlKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdCA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdCA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmVSZXN1bHQucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdC5fcmVhZEZpZWxkLCB7IG9iamVjdElkRmllbGROYW1lOiAiIiwgdW5pcXVlSWRGaWVsZDogbnVsbCwgZ2xvYmFsSWRGaWVsZE5hbWU6ICIiLCBnZW9oYXNoRmllbGROYW1lOiAiIiwgZ2VvbWV0cnlQcm9wZXJ0aWVzOiBudWxsLCBzZXJ2ZXJHZW5zOiBudWxsLCBnZW9tZXRyeVR5cGU6IDAsIHNwYXRpYWxSZWZlcmVuY2U6IG51bGwsIGV4Y2VlZGVkVHJhbnNmZXJMaW1pdDogZmFsc2UsIGhhc1o6IGZhbHNlLCBoYXNNOiBmYWxzZSwgdHJhbnNmb3JtOiBudWxsLCBmaWVsZHM6IFtdLCB2YWx1ZXM6IFtdLCBmZWF0dXJlczogW10gfSwgZW5kKTsNCiAgICAgIH07DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZVJlc3VsdC5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAodGFnID09PSAxKQ0KICAgICAgICAgICAgICBvYmoub2JqZWN0SWRGaWVsZE5hbWUgPSBwYmYucmVhZFN0cmluZygpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLnVuaXF1ZUlkRmllbGQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC5yZWFkKHBiZiwgcGJmLnJlYWRWYXJpbnQoKSArIHBiZi5wb3MpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMykNCiAgICAgICAgICAgICAgb2JqLmdsb2JhbElkRmllbGROYW1lID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDQpDQogICAgICAgICAgICAgIG9iai5nZW9oYXNoRmllbGROYW1lID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDUpDQogICAgICAgICAgICAgIG9iai5nZW9tZXRyeVByb3BlcnRpZXMgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuR2VvbWV0cnlQcm9wZXJ0aWVzLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA2KQ0KICAgICAgICAgICAgICBvYmouc2VydmVyR2VucyA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSA3KQ0KICAgICAgICAgICAgICBvYmouZ2VvbWV0cnlUeXBlID0gcGJmLnJlYWRWYXJpbnQoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDgpDQogICAgICAgICAgICAgIG9iai5zcGF0aWFsUmVmZXJlbmNlID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNwYXRpYWxSZWZlcmVuY2UucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDkpDQogICAgICAgICAgICAgIG9iai5leGNlZWRlZFRyYW5zZmVyTGltaXQgPSBwYmYucmVhZEJvb2xlYW4oKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDEwKQ0KICAgICAgICAgICAgICBvYmouaGFzWiA9IHBiZi5yZWFkQm9vbGVhbigpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMTEpDQogICAgICAgICAgICAgIG9iai5oYXNNID0gcGJmLnJlYWRCb29sZWFuKCk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAxMikNCiAgICAgICAgICAgICAgb2JqLnRyYW5zZm9ybSA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5UcmFuc2Zvcm0ucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDEzKQ0KICAgICAgICAgICAgICBvYmouZmllbGRzLnB1c2goRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcykpOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMTQpDQogICAgICAgICAgICAgIG9iai52YWx1ZXMucHVzaChGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSk7DQogICAgICAgICAgZWxzZSBpZiAodGFnID09PSAxNSkNCiAgICAgICAgICAgICAgb2JqLmZlYXR1cmVzLnB1c2goRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmUucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKSk7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZlYXR1cmVSZXN1bHQud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLm9iamVjdElkRmllbGROYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmoub2JqZWN0SWRGaWVsZE5hbWUpOw0KICAgICAgICAgIGlmIChvYmoudW5pcXVlSWRGaWVsZCkNCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVW5pcXVlSWRGaWVsZC53cml0ZSwgb2JqLnVuaXF1ZUlkRmllbGQpOw0KICAgICAgICAgIGlmIChvYmouZ2xvYmFsSWRGaWVsZE5hbWUpDQogICAgICAgICAgICAgIHBiZi53cml0ZVN0cmluZ0ZpZWxkKDMsIG9iai5nbG9iYWxJZEZpZWxkTmFtZSk7DQogICAgICAgICAgaWYgKG9iai5nZW9oYXNoRmllbGROYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCg0LCBvYmouZ2VvaGFzaEZpZWxkTmFtZSk7DQogICAgICAgICAgaWYgKG9iai5nZW9tZXRyeVByb3BlcnRpZXMpDQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoNSwgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkdlb21ldHJ5UHJvcGVydGllcy53cml0ZSwgb2JqLmdlb21ldHJ5UHJvcGVydGllcyk7DQogICAgICAgICAgaWYgKG9iai5zZXJ2ZXJHZW5zKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDYsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5TZXJ2ZXJHZW5zLndyaXRlLCBvYmouc2VydmVyR2Vucyk7DQogICAgICAgICAgaWYgKG9iai5nZW9tZXRyeVR5cGUpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDcsIG9iai5nZW9tZXRyeVR5cGUpOw0KICAgICAgICAgIGlmIChvYmouc3BhdGlhbFJlZmVyZW5jZSkNCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSg4LCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU3BhdGlhbFJlZmVyZW5jZS53cml0ZSwgb2JqLnNwYXRpYWxSZWZlcmVuY2UpOw0KICAgICAgICAgIGlmIChvYmouZXhjZWVkZWRUcmFuc2ZlckxpbWl0KQ0KICAgICAgICAgICAgICBwYmYud3JpdGVCb29sZWFuRmllbGQoOSwgb2JqLmV4Y2VlZGVkVHJhbnNmZXJMaW1pdCk7DQogICAgICAgICAgaWYgKG9iai5oYXNaKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVCb29sZWFuRmllbGQoMTAsIG9iai5oYXNaKTsNCiAgICAgICAgICBpZiAob2JqLmhhc00pDQogICAgICAgICAgICAgIHBiZi53cml0ZUJvb2xlYW5GaWVsZCgxMSwgb2JqLmhhc00pOw0KICAgICAgICAgIGlmIChvYmoudHJhbnNmb3JtKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDEyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVHJhbnNmb3JtLndyaXRlLCBvYmoudHJhbnNmb3JtKTsNCiAgICAgICAgICBpZiAob2JqLmZpZWxkcykNCiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmouZmllbGRzLmxlbmd0aDsgaSsrKQ0KICAgICAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgxMywgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkZpZWxkLndyaXRlLCBvYmouZmllbGRzW2ldKTsNCiAgICAgICAgICBpZiAob2JqLnZhbHVlcykNCiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9iai52YWx1ZXMubGVuZ3RoOyBpKyspDQogICAgICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDE0LCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuVmFsdWUud3JpdGUsIG9iai52YWx1ZXNbaV0pOw0KICAgICAgICAgIGlmIChvYmouZmVhdHVyZXMpDQogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmouZmVhdHVyZXMubGVuZ3RoOyBpKyspDQogICAgICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDE1LCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuRmVhdHVyZS53cml0ZSwgb2JqLmZlYXR1cmVzW2ldKTsNCiAgICAgIH07DQogICAgICAvLyBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQ0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkNvdW50UmVzdWx0ID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQucmVhZCA9IGZ1bmN0aW9uIChwYmYsIGVuZCkgew0KICAgICAgICAgIHJldHVybiBwYmYucmVhZEZpZWxkcyhGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQuX3JlYWRGaWVsZCwgeyBjb3VudDogMCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5Db3VudFJlc3VsdC5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAodGFnID09PSAxKQ0KICAgICAgICAgICAgICBvYmouY291bnQgPSBwYmYucmVhZFZhcmludCgpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5Db3VudFJlc3VsdC53cml0ZSA9IGZ1bmN0aW9uIChvYmosIHBiZikgew0KICAgICAgICAgIGlmIChvYmouY291bnQpDQogICAgICAgICAgICAgIHBiZi53cml0ZVZhcmludEZpZWxkKDEsIG9iai5jb3VudCk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLk9iamVjdElkc1Jlc3VsdCA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0ID0ge307DQogICAgICBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLk9iamVjdElkc1Jlc3VsdC5fcmVhZEZpZWxkLCB7IG9iamVjdElkRmllbGROYW1lOiAiIiwgc2VydmVyR2VuczogbnVsbCwgb2JqZWN0SWRzOiBbXSB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5PYmplY3RJZHNSZXN1bHQuX3JlYWRGaWVsZCA9IGZ1bmN0aW9uICh0YWcsIG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKHRhZyA9PT0gMSkNCiAgICAgICAgICAgICAgb2JqLm9iamVjdElkRmllbGROYW1lID0gcGJmLnJlYWRTdHJpbmcoKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDIpDQogICAgICAgICAgICAgIG9iai5zZXJ2ZXJHZW5zID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlNlcnZlckdlbnMucmVhZChwYmYsIHBiZi5yZWFkVmFyaW50KCkgKyBwYmYucG9zKTsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIHBiZi5yZWFkUGFja2VkVmFyaW50KG9iai5vYmplY3RJZHMpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5PYmplY3RJZHNSZXN1bHQud3JpdGUgPSBmdW5jdGlvbiAob2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAob2JqLm9iamVjdElkRmllbGROYW1lKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVTdHJpbmdGaWVsZCgxLCBvYmoub2JqZWN0SWRGaWVsZE5hbWUpOw0KICAgICAgICAgIGlmIChvYmouc2VydmVyR2VucykNCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuU2VydmVyR2Vucy53cml0ZSwgb2JqLnNlcnZlckdlbnMpOw0KICAgICAgICAgIGlmIChvYmoub2JqZWN0SWRzKQ0KICAgICAgICAgICAgICBwYmYud3JpdGVQYWNrZWRWYXJpbnQoMywgb2JqLm9iamVjdElkcyk7DQogICAgICB9Ow0KICAgICAgLy8gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0ID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0NCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdCA9IHt9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0LnJlYWQgPSBmdW5jdGlvbiAocGJmLCBlbmQpIHsNCiAgICAgICAgICByZXR1cm4gcGJmLnJlYWRGaWVsZHMoRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0Ll9yZWFkRmllbGQsIHsgZmVhdHVyZVJlc3VsdDogbnVsbCwgUmVzdWx0czogbnVsbCwgY291bnRSZXN1bHQ6IG51bGwsIGlkc1Jlc3VsdDogbnVsbCB9LCBlbmQpOw0KICAgICAgfTsNCiAgICAgIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5RdWVyeVJlc3VsdC5fcmVhZEZpZWxkID0gZnVuY3Rpb24gKHRhZywgb2JqLCBwYmYpIHsNCiAgICAgICAgICBpZiAodGFnID09PSAxKQ0KICAgICAgICAgICAgICBvYmouZmVhdHVyZVJlc3VsdCA9IEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlUmVzdWx0LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyksIG9iai5SZXN1bHRzID0gImZlYXR1cmVSZXN1bHQiOw0KICAgICAgICAgIGVsc2UgaWYgKHRhZyA9PT0gMikNCiAgICAgICAgICAgICAgb2JqLmNvdW50UmVzdWx0ID0gRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLkNvdW50UmVzdWx0LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyksIG9iai5SZXN1bHRzID0gImNvdW50UmVzdWx0IjsNCiAgICAgICAgICBlbHNlIGlmICh0YWcgPT09IDMpDQogICAgICAgICAgICAgIG9iai5pZHNSZXN1bHQgPSBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuT2JqZWN0SWRzUmVzdWx0LnJlYWQocGJmLCBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyksIG9iai5SZXN1bHRzID0gImlkc1Jlc3VsdCI7DQogICAgICB9Ow0KICAgICAgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLlF1ZXJ5UmVzdWx0LndyaXRlID0gZnVuY3Rpb24gKG9iaiwgcGJmKSB7DQogICAgICAgICAgaWYgKG9iai5mZWF0dXJlUmVzdWx0KQ0KICAgICAgICAgICAgICBwYmYud3JpdGVNZXNzYWdlKDEsIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlci5GZWF0dXJlUmVzdWx0LndyaXRlLCBvYmouZmVhdHVyZVJlc3VsdCk7DQogICAgICAgICAgaWYgKG9iai5jb3VudFJlc3VsdCkNCiAgICAgICAgICAgICAgcGJmLndyaXRlTWVzc2FnZSgyLCBGZWF0dXJlQ29sbGVjdGlvblBCdWZmZXIuQ291bnRSZXN1bHQud3JpdGUsIG9iai5jb3VudFJlc3VsdCk7DQogICAgICAgICAgaWYgKG9iai5pZHNSZXN1bHQpDQogICAgICAgICAgICAgIHBiZi53cml0ZU1lc3NhZ2UoMywgRmVhdHVyZUNvbGxlY3Rpb25QQnVmZmVyLk9iamVjdElkc1Jlc3VsdC53cml0ZSwgb2JqLmlkc1Jlc3VsdCk7DQogICAgICB9Ow0KICAgICAgcmV0dXJuIEZlYXR1cmVDb2xsZWN0aW9uUEJ1ZmZlcjsNCiAgfQoKICB2YXIgaWVlZTc1NCQxID0ge307CgogIC8qISBpZWVlNzU0LiBCU0QtMy1DbGF1c2UgTGljZW5zZS4gRmVyb3NzIEFib3VraGFkaWplaCA8aHR0cHM6Ly9mZXJvc3Mub3JnL29wZW5zb3VyY2U+ICovCgogIGllZWU3NTQkMS5yZWFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtOwogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMTsKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxOwogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxOwogICAgdmFyIG5CaXRzID0gLTc7CiAgICB2YXIgaSA9IGlzTEUgPyAobkJ5dGVzIC0gMSkgOiAwOwogICAgdmFyIGQgPSBpc0xFID8gLTEgOiAxOwogICAgdmFyIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV07CgogICAgaSArPSBkOwoKICAgIGUgPSBzICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpOwogICAgcyA+Pj0gKC1uQml0cyk7CiAgICBuQml0cyArPSBlTGVuOwogICAgZm9yICg7IG5CaXRzID4gMDsgZSA9IChlICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQoKICAgIG0gPSBlICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpOwogICAgZSA+Pj0gKC1uQml0cyk7CiAgICBuQml0cyArPSBtTGVuOwogICAgZm9yICg7IG5CaXRzID4gMDsgbSA9IChtICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQoKICAgIGlmIChlID09PSAwKSB7CiAgICAgIGUgPSAxIC0gZUJpYXM7CiAgICB9IGVsc2UgaWYgKGUgPT09IGVNYXgpIHsKICAgICAgcmV0dXJuIG0gPyBOYU4gOiAoKHMgPyAtMSA6IDEpICogSW5maW5pdHkpCiAgICB9IGVsc2UgewogICAgICBtID0gbSArIE1hdGgucG93KDIsIG1MZW4pOwogICAgICBlID0gZSAtIGVCaWFzOwogICAgfQogICAgcmV0dXJuIChzID8gLTEgOiAxKSAqIG0gKiBNYXRoLnBvdygyLCBlIC0gbUxlbikKICB9OwoKICBpZWVlNzU0JDEud3JpdGUgPSBmdW5jdGlvbiAoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtLCBjOwogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMTsKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxOwogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxOwogICAgdmFyIHJ0ID0gKG1MZW4gPT09IDIzID8gTWF0aC5wb3coMiwgLTI0KSAtIE1hdGgucG93KDIsIC03NykgOiAwKTsKICAgIHZhciBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSk7CiAgICB2YXIgZCA9IGlzTEUgPyAxIDogLTE7CiAgICB2YXIgcyA9IHZhbHVlIDwgMCB8fCAodmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCkgPyAxIDogMDsKCiAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKCiAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgICBtID0gaXNOYU4odmFsdWUpID8gMSA6IDA7CiAgICAgIGUgPSBlTWF4OwogICAgfSBlbHNlIHsKICAgICAgZSA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpOwogICAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgICAgZS0tOwogICAgICAgIGMgKj0gMjsKICAgICAgfQogICAgICBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgICB2YWx1ZSArPSBydCAvIGM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICAgIGUrKzsKICAgICAgICBjIC89IDI7CiAgICAgIH0KCiAgICAgIGlmIChlICsgZUJpYXMgPj0gZU1heCkgewogICAgICAgIG0gPSAwOwogICAgICAgIGUgPSBlTWF4OwogICAgICB9IGVsc2UgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgbSA9ICgodmFsdWUgKiBjKSAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgICAgZSA9IGUgKyBlQmlhczsKICAgICAgfSBlbHNlIHsKICAgICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgICAgZSA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKDsgbUxlbiA+PSA4OyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBtICYgMHhmZiwgaSArPSBkLCBtIC89IDI1NiwgbUxlbiAtPSA4KSB7fQoKICAgIGUgPSAoZSA8PCBtTGVuKSB8IG07CiAgICBlTGVuICs9IG1MZW47CiAgICBmb3IgKDsgZUxlbiA+IDA7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGUgJiAweGZmLCBpICs9IGQsIGUgLz0gMjU2LCBlTGVuIC09IDgpIHt9CgogICAgYnVmZmVyW29mZnNldCArIGkgLSBkXSB8PSBzICogMTI4OwogIH07CgogIHZhciBwYmYgPSBQYmY7CgogIHZhciBpZWVlNzU0ID0gaWVlZTc1NCQxOwoKICBmdW5jdGlvbiBQYmYoYnVmKSB7CiAgICAgIHRoaXMuYnVmID0gQXJyYXlCdWZmZXIuaXNWaWV3ICYmIEFycmF5QnVmZmVyLmlzVmlldyhidWYpID8gYnVmIDogbmV3IFVpbnQ4QXJyYXkoYnVmIHx8IDApOwogICAgICB0aGlzLnBvcyA9IDA7CiAgICAgIHRoaXMudHlwZSA9IDA7CiAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy5idWYubGVuZ3RoOwogIH0KCiAgUGJmLlZhcmludCAgPSAwOyAvLyB2YXJpbnQ6IGludDMyLCBpbnQ2NCwgdWludDMyLCB1aW50NjQsIHNpbnQzMiwgc2ludDY0LCBib29sLCBlbnVtCiAgUGJmLkZpeGVkNjQgPSAxOyAvLyA2NC1iaXQ6IGRvdWJsZSwgZml4ZWQ2NCwgc2ZpeGVkNjQKICBQYmYuQnl0ZXMgICA9IDI7IC8vIGxlbmd0aC1kZWxpbWl0ZWQ6IHN0cmluZywgYnl0ZXMsIGVtYmVkZGVkIG1lc3NhZ2VzLCBwYWNrZWQgcmVwZWF0ZWQgZmllbGRzCiAgUGJmLkZpeGVkMzIgPSA1OyAvLyAzMi1iaXQ6IGZsb2F0LCBmaXhlZDMyLCBzZml4ZWQzMgoKICB2YXIgU0hJRlRfTEVGVF8zMiA9ICgxIDw8IDE2KSAqICgxIDw8IDE2KSwKICAgICAgU0hJRlRfUklHSFRfMzIgPSAxIC8gU0hJRlRfTEVGVF8zMjsKCiAgLy8gVGhyZXNob2xkIGNob3NlbiBiYXNlZCBvbiBib3RoIGJlbmNobWFya2luZyBhbmQga25vd2xlZGdlIGFib3V0IGJyb3dzZXIgc3RyaW5nCiAgLy8gZGF0YSBzdHJ1Y3R1cmVzICh3aGljaCBjdXJyZW50bHkgc3dpdGNoIHN0cnVjdHVyZSB0eXBlcyBhdCAxMiBieXRlcyBvciBtb3JlKQogIHZhciBURVhUX0RFQ09ERVJfTUlOX0xFTkdUSCA9IDEyOwogIHZhciB1dGY4VGV4dERlY29kZXIgPSB0eXBlb2YgVGV4dERlY29kZXIgPT09ICd1bmRlZmluZWQnID8gbnVsbCA6IG5ldyBUZXh0RGVjb2RlcigndXRmOCcpOwoKICBQYmYucHJvdG90eXBlID0gewoKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmJ1ZiA9IG51bGw7CiAgICAgIH0sCgogICAgICAvLyA9PT0gUkVBRElORyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgICAgcmVhZEZpZWxkczogZnVuY3Rpb24ocmVhZEZpZWxkLCByZXN1bHQsIGVuZCkgewogICAgICAgICAgZW5kID0gZW5kIHx8IHRoaXMubGVuZ3RoOwoKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgewogICAgICAgICAgICAgIHZhciB2YWwgPSB0aGlzLnJlYWRWYXJpbnQoKSwKICAgICAgICAgICAgICAgICAgdGFnID0gdmFsID4+IDMsCiAgICAgICAgICAgICAgICAgIHN0YXJ0UG9zID0gdGhpcy5wb3M7CgogICAgICAgICAgICAgIHRoaXMudHlwZSA9IHZhbCAmIDB4NzsKICAgICAgICAgICAgICByZWFkRmllbGQodGFnLCByZXN1bHQsIHRoaXMpOwoKICAgICAgICAgICAgICBpZiAodGhpcy5wb3MgPT09IHN0YXJ0UG9zKSB0aGlzLnNraXAodmFsKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0sCgogICAgICByZWFkTWVzc2FnZTogZnVuY3Rpb24ocmVhZEZpZWxkLCByZXN1bHQpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnJlYWRGaWVsZHMocmVhZEZpZWxkLCByZXN1bHQsIHRoaXMucmVhZFZhcmludCgpICsgdGhpcy5wb3MpOwogICAgICB9LAoKICAgICAgcmVhZEZpeGVkMzI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZhbCA9IHJlYWRVSW50MzIodGhpcy5idWYsIHRoaXMucG9zKTsKICAgICAgICAgIHRoaXMucG9zICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICB9LAoKICAgICAgcmVhZFNGaXhlZDMyOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB2YWwgPSByZWFkSW50MzIodGhpcy5idWYsIHRoaXMucG9zKTsKICAgICAgICAgIHRoaXMucG9zICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICB9LAoKICAgICAgLy8gNjQtYml0IGludCBoYW5kbGluZyBpcyBiYXNlZCBvbiBnaXRodWIuY29tL2Rwdy9ub2RlLWJ1ZmZlci1tb3JlLWludHMgKE1JVC1saWNlbnNlZCkKCiAgICAgIHJlYWRGaXhlZDY0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB2YWwgPSByZWFkVUludDMyKHRoaXMuYnVmLCB0aGlzLnBvcykgKyByZWFkVUludDMyKHRoaXMuYnVmLCB0aGlzLnBvcyArIDQpICogU0hJRlRfTEVGVF8zMjsKICAgICAgICAgIHRoaXMucG9zICs9IDg7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICB9LAoKICAgICAgcmVhZFNGaXhlZDY0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB2YWwgPSByZWFkVUludDMyKHRoaXMuYnVmLCB0aGlzLnBvcykgKyByZWFkSW50MzIodGhpcy5idWYsIHRoaXMucG9zICsgNCkgKiBTSElGVF9MRUZUXzMyOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICByZWFkRmxvYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZhbCA9IGllZWU3NTQucmVhZCh0aGlzLmJ1ZiwgdGhpcy5wb3MsIHRydWUsIDIzLCA0KTsKICAgICAgICAgIHRoaXMucG9zICs9IDQ7CiAgICAgICAgICByZXR1cm4gdmFsOwogICAgICB9LAoKICAgICAgcmVhZERvdWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdmFsID0gaWVlZTc1NC5yZWFkKHRoaXMuYnVmLCB0aGlzLnBvcywgdHJ1ZSwgNTIsIDgpOwogICAgICAgICAgdGhpcy5wb3MgKz0gODsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0sCgogICAgICByZWFkVmFyaW50OiBmdW5jdGlvbihpc1NpZ25lZCkgewogICAgICAgICAgdmFyIGJ1ZiA9IHRoaXMuYnVmLAogICAgICAgICAgICAgIHZhbCwgYjsKCiAgICAgICAgICBiID0gYnVmW3RoaXMucG9zKytdOyB2YWwgID0gIGIgJiAweDdmOyAgICAgICAgaWYgKGIgPCAweDgwKSByZXR1cm4gdmFsOwogICAgICAgICAgYiA9IGJ1Zlt0aGlzLnBvcysrXTsgdmFsIHw9IChiICYgMHg3ZikgPDwgNzsgIGlmIChiIDwgMHg4MCkgcmV0dXJuIHZhbDsKICAgICAgICAgIGIgPSBidWZbdGhpcy5wb3MrK107IHZhbCB8PSAoYiAmIDB4N2YpIDw8IDE0OyBpZiAoYiA8IDB4ODApIHJldHVybiB2YWw7CiAgICAgICAgICBiID0gYnVmW3RoaXMucG9zKytdOyB2YWwgfD0gKGIgJiAweDdmKSA8PCAyMTsgaWYgKGIgPCAweDgwKSByZXR1cm4gdmFsOwogICAgICAgICAgYiA9IGJ1Zlt0aGlzLnBvc107ICAgdmFsIHw9IChiICYgMHgwZikgPDwgMjg7CgogICAgICAgICAgcmV0dXJuIHJlYWRWYXJpbnRSZW1haW5kZXIodmFsLCBpc1NpZ25lZCwgdGhpcyk7CiAgICAgIH0sCgogICAgICByZWFkVmFyaW50NjQ6IGZ1bmN0aW9uKCkgeyAvLyBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIHYyLjAuMQogICAgICAgICAgcmV0dXJuIHRoaXMucmVhZFZhcmludCh0cnVlKTsKICAgICAgfSwKCiAgICAgIHJlYWRTVmFyaW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBudW0gPSB0aGlzLnJlYWRWYXJpbnQoKTsKICAgICAgICAgIHJldHVybiBudW0gJSAyID09PSAxID8gKG51bSArIDEpIC8gLTIgOiBudW0gLyAyOyAvLyB6aWd6YWcgZW5jb2RpbmcKICAgICAgfSwKCiAgICAgIHJlYWRCb29sZWFuOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBCb29sZWFuKHRoaXMucmVhZFZhcmludCgpKTsKICAgICAgfSwKCiAgICAgIHJlYWRTdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGVuZCA9IHRoaXMucmVhZFZhcmludCgpICsgdGhpcy5wb3M7CiAgICAgICAgICB2YXIgcG9zID0gdGhpcy5wb3M7CiAgICAgICAgICB0aGlzLnBvcyA9IGVuZDsKCiAgICAgICAgICBpZiAoZW5kIC0gcG9zID49IFRFWFRfREVDT0RFUl9NSU5fTEVOR1RIICYmIHV0ZjhUZXh0RGVjb2RlcikgewogICAgICAgICAgICAgIC8vIGxvbmdlciBzdHJpbmdzIGFyZSBmYXN0IHdpdGggdGhlIGJ1aWx0LWluIGJyb3dzZXIgVGV4dERlY29kZXIgQVBJCiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRVdGY4VGV4dERlY29kZXIodGhpcy5idWYsIHBvcywgZW5kKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHNob3J0IHN0cmluZ3MgYXJlIGZhc3Qgd2l0aCBvdXIgY3VzdG9tIGltcGxlbWVudGF0aW9uCiAgICAgICAgICByZXR1cm4gcmVhZFV0ZjgodGhpcy5idWYsIHBvcywgZW5kKTsKICAgICAgfSwKCiAgICAgIHJlYWRCeXRlczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZW5kID0gdGhpcy5yZWFkVmFyaW50KCkgKyB0aGlzLnBvcywKICAgICAgICAgICAgICBidWZmZXIgPSB0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnBvcywgZW5kKTsKICAgICAgICAgIHRoaXMucG9zID0gZW5kOwogICAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfSwKCiAgICAgIC8vIHZlcmJvc2UgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnM7IGRvZXNuJ3QgYWZmZWN0IGd6aXBwZWQgc2l6ZQoKICAgICAgcmVhZFBhY2tlZFZhcmludDogZnVuY3Rpb24oYXJyLCBpc1NpZ25lZCkgewogICAgICAgICAgaWYgKHRoaXMudHlwZSAhPT0gUGJmLkJ5dGVzKSByZXR1cm4gYXJyLnB1c2godGhpcy5yZWFkVmFyaW50KGlzU2lnbmVkKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkVmFyaW50KGlzU2lnbmVkKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkU1ZhcmludDogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRTVmFyaW50KCkpOwogICAgICAgICAgdmFyIGVuZCA9IHJlYWRQYWNrZWRFbmQodGhpcyk7CiAgICAgICAgICBhcnIgPSBhcnIgfHwgW107CiAgICAgICAgICB3aGlsZSAodGhpcy5wb3MgPCBlbmQpIGFyci5wdXNoKHRoaXMucmVhZFNWYXJpbnQoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkQm9vbGVhbjogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRCb29sZWFuKCkpOwogICAgICAgICAgdmFyIGVuZCA9IHJlYWRQYWNrZWRFbmQodGhpcyk7CiAgICAgICAgICBhcnIgPSBhcnIgfHwgW107CiAgICAgICAgICB3aGlsZSAodGhpcy5wb3MgPCBlbmQpIGFyci5wdXNoKHRoaXMucmVhZEJvb2xlYW4oKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkRmxvYXQ6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgaWYgKHRoaXMudHlwZSAhPT0gUGJmLkJ5dGVzKSByZXR1cm4gYXJyLnB1c2godGhpcy5yZWFkRmxvYXQoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkRmxvYXQoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkRG91YmxlOiBmdW5jdGlvbihhcnIpIHsKICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT09IFBiZi5CeXRlcykgcmV0dXJuIGFyci5wdXNoKHRoaXMucmVhZERvdWJsZSgpKTsKICAgICAgICAgIHZhciBlbmQgPSByZWFkUGFja2VkRW5kKHRoaXMpOwogICAgICAgICAgYXJyID0gYXJyIHx8IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMucG9zIDwgZW5kKSBhcnIucHVzaCh0aGlzLnJlYWREb3VibGUoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkRml4ZWQzMjogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRGaXhlZDMyKCkpOwogICAgICAgICAgdmFyIGVuZCA9IHJlYWRQYWNrZWRFbmQodGhpcyk7CiAgICAgICAgICBhcnIgPSBhcnIgfHwgW107CiAgICAgICAgICB3aGlsZSAodGhpcy5wb3MgPCBlbmQpIGFyci5wdXNoKHRoaXMucmVhZEZpeGVkMzIoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkU0ZpeGVkMzI6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgaWYgKHRoaXMudHlwZSAhPT0gUGJmLkJ5dGVzKSByZXR1cm4gYXJyLnB1c2godGhpcy5yZWFkU0ZpeGVkMzIoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkU0ZpeGVkMzIoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkRml4ZWQ2NDogZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICBpZiAodGhpcy50eXBlICE9PSBQYmYuQnl0ZXMpIHJldHVybiBhcnIucHVzaCh0aGlzLnJlYWRGaXhlZDY0KCkpOwogICAgICAgICAgdmFyIGVuZCA9IHJlYWRQYWNrZWRFbmQodGhpcyk7CiAgICAgICAgICBhcnIgPSBhcnIgfHwgW107CiAgICAgICAgICB3aGlsZSAodGhpcy5wb3MgPCBlbmQpIGFyci5wdXNoKHRoaXMucmVhZEZpeGVkNjQoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAogICAgICByZWFkUGFja2VkU0ZpeGVkNjQ6IGZ1bmN0aW9uKGFycikgewogICAgICAgICAgaWYgKHRoaXMudHlwZSAhPT0gUGJmLkJ5dGVzKSByZXR1cm4gYXJyLnB1c2godGhpcy5yZWFkU0ZpeGVkNjQoKSk7CiAgICAgICAgICB2YXIgZW5kID0gcmVhZFBhY2tlZEVuZCh0aGlzKTsKICAgICAgICAgIGFyciA9IGFyciB8fCBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLnBvcyA8IGVuZCkgYXJyLnB1c2godGhpcy5yZWFkU0ZpeGVkNjQoKSk7CiAgICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAoKICAgICAgc2tpcDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHZhbCAmIDB4NzsKICAgICAgICAgIGlmICh0eXBlID09PSBQYmYuVmFyaW50KSB3aGlsZSAodGhpcy5idWZbdGhpcy5wb3MrK10gPiAweDdmKSB7fQogICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gUGJmLkJ5dGVzKSB0aGlzLnBvcyA9IHRoaXMucmVhZFZhcmludCgpICsgdGhpcy5wb3M7CiAgICAgICAgICBlbHNlIGlmICh0eXBlID09PSBQYmYuRml4ZWQzMikgdGhpcy5wb3MgKz0gNDsKICAgICAgICAgIGVsc2UgaWYgKHR5cGUgPT09IFBiZi5GaXhlZDY0KSB0aGlzLnBvcyArPSA4OwogICAgICAgICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoJ1VuaW1wbGVtZW50ZWQgdHlwZTogJyArIHR5cGUpOwogICAgICB9LAoKICAgICAgLy8gPT09IFdSSVRJTkcgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgIHdyaXRlVGFnOiBmdW5jdGlvbih0YWcsIHR5cGUpIHsKICAgICAgICAgIHRoaXMud3JpdGVWYXJpbnQoKHRhZyA8PCAzKSB8IHR5cGUpOwogICAgICB9LAoKICAgICAgcmVhbGxvYzogZnVuY3Rpb24obWluKSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggfHwgMTY7CgogICAgICAgICAgd2hpbGUgKGxlbmd0aCA8IHRoaXMucG9zICsgbWluKSBsZW5ndGggKj0gMjsKCiAgICAgICAgICBpZiAobGVuZ3RoICE9PSB0aGlzLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBidWYgPSBuZXcgVWludDhBcnJheShsZW5ndGgpOwogICAgICAgICAgICAgIGJ1Zi5zZXQodGhpcy5idWYpOwogICAgICAgICAgICAgIHRoaXMuYnVmID0gYnVmOwogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgZmluaXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMubGVuZ3RoID0gdGhpcy5wb3M7CiAgICAgICAgICB0aGlzLnBvcyA9IDA7CiAgICAgICAgICByZXR1cm4gdGhpcy5idWYuc3ViYXJyYXkoMCwgdGhpcy5sZW5ndGgpOwogICAgICB9LAoKICAgICAgd3JpdGVGaXhlZDMyOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHRoaXMucmVhbGxvYyg0KTsKICAgICAgICAgIHdyaXRlSW50MzIodGhpcy5idWYsIHZhbCwgdGhpcy5wb3MpOwogICAgICAgICAgdGhpcy5wb3MgKz0gNDsKICAgICAgfSwKCiAgICAgIHdyaXRlU0ZpeGVkMzI6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDQpOwogICAgICAgICAgd3JpdGVJbnQzMih0aGlzLmJ1ZiwgdmFsLCB0aGlzLnBvcyk7CiAgICAgICAgICB0aGlzLnBvcyArPSA0OwogICAgICB9LAoKICAgICAgd3JpdGVGaXhlZDY0OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHRoaXMucmVhbGxvYyg4KTsKICAgICAgICAgIHdyaXRlSW50MzIodGhpcy5idWYsIHZhbCAmIC0xLCB0aGlzLnBvcyk7CiAgICAgICAgICB3cml0ZUludDMyKHRoaXMuYnVmLCBNYXRoLmZsb29yKHZhbCAqIFNISUZUX1JJR0hUXzMyKSwgdGhpcy5wb3MgKyA0KTsKICAgICAgICAgIHRoaXMucG9zICs9IDg7CiAgICAgIH0sCgogICAgICB3cml0ZVNGaXhlZDY0OiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHRoaXMucmVhbGxvYyg4KTsKICAgICAgICAgIHdyaXRlSW50MzIodGhpcy5idWYsIHZhbCAmIC0xLCB0aGlzLnBvcyk7CiAgICAgICAgICB3cml0ZUludDMyKHRoaXMuYnVmLCBNYXRoLmZsb29yKHZhbCAqIFNISUZUX1JJR0hUXzMyKSwgdGhpcy5wb3MgKyA0KTsKICAgICAgICAgIHRoaXMucG9zICs9IDg7CiAgICAgIH0sCgogICAgICB3cml0ZVZhcmludDogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB2YWwgPSArdmFsIHx8IDA7CgogICAgICAgICAgaWYgKHZhbCA+IDB4ZmZmZmZmZiB8fCB2YWwgPCAwKSB7CiAgICAgICAgICAgICAgd3JpdGVCaWdWYXJpbnQodmFsLCB0aGlzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5yZWFsbG9jKDQpOwoKICAgICAgICAgIHRoaXMuYnVmW3RoaXMucG9zKytdID0gICAgICAgICAgIHZhbCAmIDB4N2YgIHwgKHZhbCA+IDB4N2YgPyAweDgwIDogMCk7IGlmICh2YWwgPD0gMHg3ZikgcmV0dXJuOwogICAgICAgICAgdGhpcy5idWZbdGhpcy5wb3MrK10gPSAoKHZhbCA+Pj49IDcpICYgMHg3ZikgfCAodmFsID4gMHg3ZiA/IDB4ODAgOiAwKTsgaWYgKHZhbCA8PSAweDdmKSByZXR1cm47CiAgICAgICAgICB0aGlzLmJ1Zlt0aGlzLnBvcysrXSA9ICgodmFsID4+Pj0gNykgJiAweDdmKSB8ICh2YWwgPiAweDdmID8gMHg4MCA6IDApOyBpZiAodmFsIDw9IDB4N2YpIHJldHVybjsKICAgICAgICAgIHRoaXMuYnVmW3RoaXMucG9zKytdID0gICAodmFsID4+PiA3KSAmIDB4N2Y7CiAgICAgIH0sCgogICAgICB3cml0ZVNWYXJpbnQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVZhcmludCh2YWwgPCAwID8gLXZhbCAqIDIgLSAxIDogdmFsICogMik7CiAgICAgIH0sCgogICAgICB3cml0ZUJvb2xlYW46IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVZhcmludChCb29sZWFuKHZhbCkpOwogICAgICB9LAoKICAgICAgd3JpdGVTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICAgICAgc3RyID0gU3RyaW5nKHN0cik7CiAgICAgICAgICB0aGlzLnJlYWxsb2Moc3RyLmxlbmd0aCAqIDQpOwoKICAgICAgICAgIHRoaXMucG9zKys7IC8vIHJlc2VydmUgMSBieXRlIGZvciBzaG9ydCBzdHJpbmcgbGVuZ3RoCgogICAgICAgICAgdmFyIHN0YXJ0UG9zID0gdGhpcy5wb3M7CiAgICAgICAgICAvLyB3cml0ZSB0aGUgc3RyaW5nIGRpcmVjdGx5IHRvIHRoZSBidWZmZXIgYW5kIHNlZSBob3cgbXVjaCB3YXMgd3JpdHRlbgogICAgICAgICAgdGhpcy5wb3MgPSB3cml0ZVV0ZjgodGhpcy5idWYsIHN0ciwgdGhpcy5wb3MpOwogICAgICAgICAgdmFyIGxlbiA9IHRoaXMucG9zIC0gc3RhcnRQb3M7CgogICAgICAgICAgaWYgKGxlbiA+PSAweDgwKSBtYWtlUm9vbUZvckV4dHJhTGVuZ3RoKHN0YXJ0UG9zLCBsZW4sIHRoaXMpOwoKICAgICAgICAgIC8vIGZpbmFsbHksIHdyaXRlIHRoZSBtZXNzYWdlIGxlbmd0aCBpbiB0aGUgcmVzZXJ2ZWQgcGxhY2UgYW5kIHJlc3RvcmUgdGhlIHBvc2l0aW9uCiAgICAgICAgICB0aGlzLnBvcyA9IHN0YXJ0UG9zIC0gMTsKICAgICAgICAgIHRoaXMud3JpdGVWYXJpbnQobGVuKTsKICAgICAgICAgIHRoaXMucG9zICs9IGxlbjsKICAgICAgfSwKCiAgICAgIHdyaXRlRmxvYXQ6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdGhpcy5yZWFsbG9jKDQpOwogICAgICAgICAgaWVlZTc1NC53cml0ZSh0aGlzLmJ1ZiwgdmFsLCB0aGlzLnBvcywgdHJ1ZSwgMjMsIDQpOwogICAgICAgICAgdGhpcy5wb3MgKz0gNDsKICAgICAgfSwKCiAgICAgIHdyaXRlRG91YmxlOiBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHRoaXMucmVhbGxvYyg4KTsKICAgICAgICAgIGllZWU3NTQud3JpdGUodGhpcy5idWYsIHZhbCwgdGhpcy5wb3MsIHRydWUsIDUyLCA4KTsKICAgICAgICAgIHRoaXMucG9zICs9IDg7CiAgICAgIH0sCgogICAgICB3cml0ZUJ5dGVzOiBmdW5jdGlvbihidWZmZXIpIHsKICAgICAgICAgIHZhciBsZW4gPSBidWZmZXIubGVuZ3RoOwogICAgICAgICAgdGhpcy53cml0ZVZhcmludChsZW4pOwogICAgICAgICAgdGhpcy5yZWFsbG9jKGxlbik7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB0aGlzLmJ1Zlt0aGlzLnBvcysrXSA9IGJ1ZmZlcltpXTsKICAgICAgfSwKCiAgICAgIHdyaXRlUmF3TWVzc2FnZTogZnVuY3Rpb24oZm4sIG9iaikgewogICAgICAgICAgdGhpcy5wb3MrKzsgLy8gcmVzZXJ2ZSAxIGJ5dGUgZm9yIHNob3J0IG1lc3NhZ2UgbGVuZ3RoCgogICAgICAgICAgLy8gd3JpdGUgdGhlIG1lc3NhZ2UgZGlyZWN0bHkgdG8gdGhlIGJ1ZmZlciBhbmQgc2VlIGhvdyBtdWNoIHdhcyB3cml0dGVuCiAgICAgICAgICB2YXIgc3RhcnRQb3MgPSB0aGlzLnBvczsKICAgICAgICAgIGZuKG9iaiwgdGhpcyk7CiAgICAgICAgICB2YXIgbGVuID0gdGhpcy5wb3MgLSBzdGFydFBvczsKCiAgICAgICAgICBpZiAobGVuID49IDB4ODApIG1ha2VSb29tRm9yRXh0cmFMZW5ndGgoc3RhcnRQb3MsIGxlbiwgdGhpcyk7CgogICAgICAgICAgLy8gZmluYWxseSwgd3JpdGUgdGhlIG1lc3NhZ2UgbGVuZ3RoIGluIHRoZSByZXNlcnZlZCBwbGFjZSBhbmQgcmVzdG9yZSB0aGUgcG9zaXRpb24KICAgICAgICAgIHRoaXMucG9zID0gc3RhcnRQb3MgLSAxOwogICAgICAgICAgdGhpcy53cml0ZVZhcmludChsZW4pOwogICAgICAgICAgdGhpcy5wb3MgKz0gbGVuOwogICAgICB9LAoKICAgICAgd3JpdGVNZXNzYWdlOiBmdW5jdGlvbih0YWcsIGZuLCBvYmopIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuQnl0ZXMpOwogICAgICAgICAgdGhpcy53cml0ZVJhd01lc3NhZ2UoZm4sIG9iaik7CiAgICAgIH0sCgogICAgICB3cml0ZVBhY2tlZFZhcmludDogICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZFZhcmludCwgYXJyKTsgICB9LAogICAgICB3cml0ZVBhY2tlZFNWYXJpbnQ6ICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZFNWYXJpbnQsIGFycik7ICB9LAogICAgICB3cml0ZVBhY2tlZEJvb2xlYW46ICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZEJvb2xlYW4sIGFycik7ICB9LAogICAgICB3cml0ZVBhY2tlZEZsb2F0OiAgICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZEZsb2F0LCBhcnIpOyAgICB9LAogICAgICB3cml0ZVBhY2tlZERvdWJsZTogICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZERvdWJsZSwgYXJyKTsgICB9LAogICAgICB3cml0ZVBhY2tlZEZpeGVkMzI6ICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZEZpeGVkMzIsIGFycik7ICB9LAogICAgICB3cml0ZVBhY2tlZFNGaXhlZDMyOiBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZFNGaXhlZDMyLCBhcnIpOyB9LAogICAgICB3cml0ZVBhY2tlZEZpeGVkNjQ6ICBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZEZpeGVkNjQsIGFycik7ICB9LAogICAgICB3cml0ZVBhY2tlZFNGaXhlZDY0OiBmdW5jdGlvbih0YWcsIGFycikgeyBpZiAoYXJyLmxlbmd0aCkgdGhpcy53cml0ZU1lc3NhZ2UodGFnLCB3cml0ZVBhY2tlZFNGaXhlZDY0LCBhcnIpOyB9LAoKICAgICAgd3JpdGVCeXRlc0ZpZWxkOiBmdW5jdGlvbih0YWcsIGJ1ZmZlcikgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5CeXRlcyk7CiAgICAgICAgICB0aGlzLndyaXRlQnl0ZXMoYnVmZmVyKTsKICAgICAgfSwKICAgICAgd3JpdGVGaXhlZDMyRmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkZpeGVkMzIpOwogICAgICAgICAgdGhpcy53cml0ZUZpeGVkMzIodmFsKTsKICAgICAgfSwKICAgICAgd3JpdGVTRml4ZWQzMkZpZWxkOiBmdW5jdGlvbih0YWcsIHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5GaXhlZDMyKTsKICAgICAgICAgIHRoaXMud3JpdGVTRml4ZWQzMih2YWwpOwogICAgICB9LAogICAgICB3cml0ZUZpeGVkNjRGaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuRml4ZWQ2NCk7CiAgICAgICAgICB0aGlzLndyaXRlRml4ZWQ2NCh2YWwpOwogICAgICB9LAogICAgICB3cml0ZVNGaXhlZDY0RmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkZpeGVkNjQpOwogICAgICAgICAgdGhpcy53cml0ZVNGaXhlZDY0KHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlVmFyaW50RmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLlZhcmludCk7CiAgICAgICAgICB0aGlzLndyaXRlVmFyaW50KHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlU1ZhcmludEZpZWxkOiBmdW5jdGlvbih0YWcsIHZhbCkgewogICAgICAgICAgdGhpcy53cml0ZVRhZyh0YWcsIFBiZi5WYXJpbnQpOwogICAgICAgICAgdGhpcy53cml0ZVNWYXJpbnQodmFsKTsKICAgICAgfSwKICAgICAgd3JpdGVTdHJpbmdGaWVsZDogZnVuY3Rpb24odGFnLCBzdHIpIHsKICAgICAgICAgIHRoaXMud3JpdGVUYWcodGFnLCBQYmYuQnl0ZXMpOwogICAgICAgICAgdGhpcy53cml0ZVN0cmluZyhzdHIpOwogICAgICB9LAogICAgICB3cml0ZUZsb2F0RmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkZpeGVkMzIpOwogICAgICAgICAgdGhpcy53cml0ZUZsb2F0KHZhbCk7CiAgICAgIH0sCiAgICAgIHdyaXRlRG91YmxlRmllbGQ6IGZ1bmN0aW9uKHRhZywgdmFsKSB7CiAgICAgICAgICB0aGlzLndyaXRlVGFnKHRhZywgUGJmLkZpeGVkNjQpOwogICAgICAgICAgdGhpcy53cml0ZURvdWJsZSh2YWwpOwogICAgICB9LAogICAgICB3cml0ZUJvb2xlYW5GaWVsZDogZnVuY3Rpb24odGFnLCB2YWwpIHsKICAgICAgICAgIHRoaXMud3JpdGVWYXJpbnRGaWVsZCh0YWcsIEJvb2xlYW4odmFsKSk7CiAgICAgIH0KICB9OwoKICBmdW5jdGlvbiByZWFkVmFyaW50UmVtYWluZGVyKGwsIHMsIHApIHsKICAgICAgdmFyIGJ1ZiA9IHAuYnVmLAogICAgICAgICAgaCwgYjsKCiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggID0gKGIgJiAweDcwKSA+PiA0OyAgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggfD0gKGIgJiAweDdmKSA8PCAzOyAgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggfD0gKGIgJiAweDdmKSA8PCAxMDsgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggfD0gKGIgJiAweDdmKSA8PCAxNzsgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggfD0gKGIgJiAweDdmKSA8PCAyNDsgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CiAgICAgIGIgPSBidWZbcC5wb3MrK107IGggfD0gKGIgJiAweDAxKSA8PCAzMTsgaWYgKGIgPCAweDgwKSByZXR1cm4gdG9OdW0obCwgaCwgcyk7CgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4cGVjdGVkIHZhcmludCBub3QgbW9yZSB0aGFuIDEwIGJ5dGVzJyk7CiAgfQoKICBmdW5jdGlvbiByZWFkUGFja2VkRW5kKHBiZikgewogICAgICByZXR1cm4gcGJmLnR5cGUgPT09IFBiZi5CeXRlcyA/CiAgICAgICAgICBwYmYucmVhZFZhcmludCgpICsgcGJmLnBvcyA6IHBiZi5wb3MgKyAxOwogIH0KCiAgZnVuY3Rpb24gdG9OdW0obG93LCBoaWdoLCBpc1NpZ25lZCkgewogICAgICBpZiAoaXNTaWduZWQpIHsKICAgICAgICAgIHJldHVybiBoaWdoICogMHgxMDAwMDAwMDAgKyAobG93ID4+PiAwKTsKICAgICAgfQoKICAgICAgcmV0dXJuICgoaGlnaCA+Pj4gMCkgKiAweDEwMDAwMDAwMCkgKyAobG93ID4+PiAwKTsKICB9CgogIGZ1bmN0aW9uIHdyaXRlQmlnVmFyaW50KHZhbCwgcGJmKSB7CiAgICAgIHZhciBsb3csIGhpZ2g7CgogICAgICBpZiAodmFsID49IDApIHsKICAgICAgICAgIGxvdyAgPSAodmFsICUgMHgxMDAwMDAwMDApIHwgMDsKICAgICAgICAgIGhpZ2ggPSAodmFsIC8gMHgxMDAwMDAwMDApIHwgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIGxvdyAgPSB+KC12YWwgJSAweDEwMDAwMDAwMCk7CiAgICAgICAgICBoaWdoID0gfigtdmFsIC8gMHgxMDAwMDAwMDApOwoKICAgICAgICAgIGlmIChsb3cgXiAweGZmZmZmZmZmKSB7CiAgICAgICAgICAgICAgbG93ID0gKGxvdyArIDEpIHwgMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG93ID0gMDsKICAgICAgICAgICAgICBoaWdoID0gKGhpZ2ggKyAxKSB8IDA7CiAgICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh2YWwgPj0gMHgxMDAwMDAwMDAwMDAwMDAwMCB8fCB2YWwgPCAtMHgxMDAwMDAwMDAwMDAwMDAwMCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdHaXZlbiB2YXJpbnQgZG9lc25cJ3QgZml0IGludG8gMTAgYnl0ZXMnKTsKICAgICAgfQoKICAgICAgcGJmLnJlYWxsb2MoMTApOwoKICAgICAgd3JpdGVCaWdWYXJpbnRMb3cobG93LCBoaWdoLCBwYmYpOwogICAgICB3cml0ZUJpZ1ZhcmludEhpZ2goaGlnaCwgcGJmKTsKICB9CgogIGZ1bmN0aW9uIHdyaXRlQmlnVmFyaW50TG93KGxvdywgaGlnaCwgcGJmKSB7CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSA9IGxvdyAmIDB4N2YgfCAweDgwOyBsb3cgPj4+PSA3OwogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gPSBsb3cgJiAweDdmIHwgMHg4MDsgbG93ID4+Pj0gNzsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdID0gbG93ICYgMHg3ZiB8IDB4ODA7IGxvdyA+Pj49IDc7CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSA9IGxvdyAmIDB4N2YgfCAweDgwOyBsb3cgPj4+PSA3OwogICAgICBwYmYuYnVmW3BiZi5wb3NdICAgPSBsb3cgJiAweDdmOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVCaWdWYXJpbnRIaWdoKGhpZ2gsIHBiZikgewogICAgICB2YXIgbHNiID0gKGhpZ2ggJiAweDA3KSA8PCA0OwoKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdIHw9IGxzYiAgICAgICAgIHwgKChoaWdoID4+Pj0gMykgPyAweDgwIDogMCk7IGlmICghaGlnaCkgcmV0dXJuOwogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gID0gaGlnaCAmIDB4N2YgfCAoKGhpZ2ggPj4+PSA3KSA/IDB4ODAgOiAwKTsgaWYgKCFoaWdoKSByZXR1cm47CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSAgPSBoaWdoICYgMHg3ZiB8ICgoaGlnaCA+Pj49IDcpID8gMHg4MCA6IDApOyBpZiAoIWhpZ2gpIHJldHVybjsKICAgICAgcGJmLmJ1ZltwYmYucG9zKytdICA9IGhpZ2ggJiAweDdmIHwgKChoaWdoID4+Pj0gNykgPyAweDgwIDogMCk7IGlmICghaGlnaCkgcmV0dXJuOwogICAgICBwYmYuYnVmW3BiZi5wb3MrK10gID0gaGlnaCAmIDB4N2YgfCAoKGhpZ2ggPj4+PSA3KSA/IDB4ODAgOiAwKTsgaWYgKCFoaWdoKSByZXR1cm47CiAgICAgIHBiZi5idWZbcGJmLnBvcysrXSAgPSBoaWdoICYgMHg3ZjsKICB9CgogIGZ1bmN0aW9uIG1ha2VSb29tRm9yRXh0cmFMZW5ndGgoc3RhcnRQb3MsIGxlbiwgcGJmKSB7CiAgICAgIHZhciBleHRyYUxlbiA9CiAgICAgICAgICBsZW4gPD0gMHgzZmZmID8gMSA6CiAgICAgICAgICBsZW4gPD0gMHgxZmZmZmYgPyAyIDoKICAgICAgICAgIGxlbiA8PSAweGZmZmZmZmYgPyAzIDogTWF0aC5mbG9vcihNYXRoLmxvZyhsZW4pIC8gKE1hdGguTE4yICogNykpOwoKICAgICAgLy8gaWYgMSBieXRlIGlzbid0IGVub3VnaCBmb3IgZW5jb2RpbmcgbWVzc2FnZSBsZW5ndGgsIHNoaWZ0IHRoZSBkYXRhIHRvIHRoZSByaWdodAogICAgICBwYmYucmVhbGxvYyhleHRyYUxlbik7CiAgICAgIGZvciAodmFyIGkgPSBwYmYucG9zIC0gMTsgaSA+PSBzdGFydFBvczsgaS0tKSBwYmYuYnVmW2kgKyBleHRyYUxlbl0gPSBwYmYuYnVmW2ldOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVQYWNrZWRWYXJpbnQoYXJyLCBwYmYpICAgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlVmFyaW50KGFycltpXSk7ICAgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkU1ZhcmludChhcnIsIHBiZikgIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZVNWYXJpbnQoYXJyW2ldKTsgIH0KICBmdW5jdGlvbiB3cml0ZVBhY2tlZEZsb2F0KGFyciwgcGJmKSAgICB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVGbG9hdChhcnJbaV0pOyAgICB9CiAgZnVuY3Rpb24gd3JpdGVQYWNrZWREb3VibGUoYXJyLCBwYmYpICAgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlRG91YmxlKGFycltpXSk7ICAgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkQm9vbGVhbihhcnIsIHBiZikgIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZUJvb2xlYW4oYXJyW2ldKTsgIH0KICBmdW5jdGlvbiB3cml0ZVBhY2tlZEZpeGVkMzIoYXJyLCBwYmYpICB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVGaXhlZDMyKGFycltpXSk7ICB9CiAgZnVuY3Rpb24gd3JpdGVQYWNrZWRTRml4ZWQzMihhcnIsIHBiZikgeyBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgcGJmLndyaXRlU0ZpeGVkMzIoYXJyW2ldKTsgfQogIGZ1bmN0aW9uIHdyaXRlUGFja2VkRml4ZWQ2NChhcnIsIHBiZikgIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHBiZi53cml0ZUZpeGVkNjQoYXJyW2ldKTsgIH0KICBmdW5jdGlvbiB3cml0ZVBhY2tlZFNGaXhlZDY0KGFyciwgcGJmKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSBwYmYud3JpdGVTRml4ZWQ2NChhcnJbaV0pOyB9CgogIC8vIEJ1ZmZlciBjb2RlIGJlbG93IGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2Zlcm9zcy9idWZmZXIsIE1JVC1saWNlbnNlZAoKICBmdW5jdGlvbiByZWFkVUludDMyKGJ1ZiwgcG9zKSB7CiAgICAgIHJldHVybiAoKGJ1Zltwb3NdKSB8CiAgICAgICAgICAoYnVmW3BvcyArIDFdIDw8IDgpIHwKICAgICAgICAgIChidWZbcG9zICsgMl0gPDwgMTYpKSArCiAgICAgICAgICAoYnVmW3BvcyArIDNdICogMHgxMDAwMDAwKTsKICB9CgogIGZ1bmN0aW9uIHdyaXRlSW50MzIoYnVmLCB2YWwsIHBvcykgewogICAgICBidWZbcG9zXSA9IHZhbDsKICAgICAgYnVmW3BvcyArIDFdID0gKHZhbCA+Pj4gOCk7CiAgICAgIGJ1Zltwb3MgKyAyXSA9ICh2YWwgPj4+IDE2KTsKICAgICAgYnVmW3BvcyArIDNdID0gKHZhbCA+Pj4gMjQpOwogIH0KCiAgZnVuY3Rpb24gcmVhZEludDMyKGJ1ZiwgcG9zKSB7CiAgICAgIHJldHVybiAoKGJ1Zltwb3NdKSB8CiAgICAgICAgICAoYnVmW3BvcyArIDFdIDw8IDgpIHwKICAgICAgICAgIChidWZbcG9zICsgMl0gPDwgMTYpKSArCiAgICAgICAgICAoYnVmW3BvcyArIDNdIDw8IDI0KTsKICB9CgogIGZ1bmN0aW9uIHJlYWRVdGY4KGJ1ZiwgcG9zLCBlbmQpIHsKICAgICAgdmFyIHN0ciA9ICcnOwogICAgICB2YXIgaSA9IHBvczsKCiAgICAgIHdoaWxlIChpIDwgZW5kKSB7CiAgICAgICAgICB2YXIgYjAgPSBidWZbaV07CiAgICAgICAgICB2YXIgYyA9IG51bGw7IC8vIGNvZGVwb2ludAogICAgICAgICAgdmFyIGJ5dGVzUGVyU2VxdWVuY2UgPQogICAgICAgICAgICAgIGIwID4gMHhFRiA/IDQgOgogICAgICAgICAgICAgIGIwID4gMHhERiA/IDMgOgogICAgICAgICAgICAgIGIwID4gMHhCRiA/IDIgOiAxOwoKICAgICAgICAgIGlmIChpICsgYnl0ZXNQZXJTZXF1ZW5jZSA+IGVuZCkgYnJlYWs7CgogICAgICAgICAgdmFyIGIxLCBiMiwgYjM7CgogICAgICAgICAgaWYgKGJ5dGVzUGVyU2VxdWVuY2UgPT09IDEpIHsKICAgICAgICAgICAgICBpZiAoYjAgPCAweDgwKSB7CiAgICAgICAgICAgICAgICAgIGMgPSBiMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGJ5dGVzUGVyU2VxdWVuY2UgPT09IDIpIHsKICAgICAgICAgICAgICBiMSA9IGJ1ZltpICsgMV07CiAgICAgICAgICAgICAgaWYgKChiMSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgICAgIGMgPSAoYjAgJiAweDFGKSA8PCAweDYgfCAoYjEgJiAweDNGKTsKICAgICAgICAgICAgICAgICAgaWYgKGMgPD0gMHg3RikgewogICAgICAgICAgICAgICAgICAgICAgYyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGJ5dGVzUGVyU2VxdWVuY2UgPT09IDMpIHsKICAgICAgICAgICAgICBiMSA9IGJ1ZltpICsgMV07CiAgICAgICAgICAgICAgYjIgPSBidWZbaSArIDJdOwogICAgICAgICAgICAgIGlmICgoYjEgJiAweEMwKSA9PT0gMHg4MCAmJiAoYjIgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICAgICAgICBjID0gKGIwICYgMHhGKSA8PCAweEMgfCAoYjEgJiAweDNGKSA8PCAweDYgfCAoYjIgJiAweDNGKTsKICAgICAgICAgICAgICAgICAgaWYgKGMgPD0gMHg3RkYgfHwgKGMgPj0gMHhEODAwICYmIGMgPD0gMHhERkZGKSkgewogICAgICAgICAgICAgICAgICAgICAgYyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGJ5dGVzUGVyU2VxdWVuY2UgPT09IDQpIHsKICAgICAgICAgICAgICBiMSA9IGJ1ZltpICsgMV07CiAgICAgICAgICAgICAgYjIgPSBidWZbaSArIDJdOwogICAgICAgICAgICAgIGIzID0gYnVmW2kgKyAzXTsKICAgICAgICAgICAgICBpZiAoKGIxICYgMHhDMCkgPT09IDB4ODAgJiYgKGIyICYgMHhDMCkgPT09IDB4ODAgJiYgKGIzICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICAgICAgYyA9IChiMCAmIDB4RikgPDwgMHgxMiB8IChiMSAmIDB4M0YpIDw8IDB4QyB8IChiMiAmIDB4M0YpIDw8IDB4NiB8IChiMyAmIDB4M0YpOwogICAgICAgICAgICAgICAgICBpZiAoYyA8PSAweEZGRkYgfHwgYyA+PSAweDExMDAwMCkgewogICAgICAgICAgICAgICAgICAgICAgYyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjID0gMHhGRkZEOwogICAgICAgICAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxOwoKICAgICAgICAgIH0gZWxzZSBpZiAoYyA+IDB4RkZGRikgewogICAgICAgICAgICAgIGMgLT0gMHgxMDAwMDsKICAgICAgICAgICAgICBzdHIgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKTsKICAgICAgICAgICAgICBjID0gMHhEQzAwIHwgYyAmIDB4M0ZGOwogICAgICAgICAgfQoKICAgICAgICAgIHN0ciArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGMpOwogICAgICAgICAgaSArPSBieXRlc1BlclNlcXVlbmNlOwogICAgICB9CgogICAgICByZXR1cm4gc3RyOwogIH0KCiAgZnVuY3Rpb24gcmVhZFV0ZjhUZXh0RGVjb2RlcihidWYsIHBvcywgZW5kKSB7CiAgICAgIHJldHVybiB1dGY4VGV4dERlY29kZXIuZGVjb2RlKGJ1Zi5zdWJhcnJheShwb3MsIGVuZCkpOwogIH0KCiAgZnVuY3Rpb24gd3JpdGVVdGY4KGJ1Ziwgc3RyLCBwb3MpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGMsIGxlYWQ7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGMgPSBzdHIuY2hhckNvZGVBdChpKTsgLy8gY29kZSBwb2ludAoKICAgICAgICAgIGlmIChjID4gMHhEN0ZGICYmIGMgPCAweEUwMDApIHsKICAgICAgICAgICAgICBpZiAobGVhZCkgewogICAgICAgICAgICAgICAgICBpZiAoYyA8IDB4REMwMCkgewogICAgICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4RUY7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gMHhCRjsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEJEOwogICAgICAgICAgICAgICAgICAgICAgbGVhZCA9IGM7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGMgPSBsZWFkIC0gMHhEODAwIDw8IDEwIHwgYyAtIDB4REMwMCB8IDB4MTAwMDA7CiAgICAgICAgICAgICAgICAgICAgICBsZWFkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjID4gMHhEQkZGIHx8IChpICsgMSA9PT0gc3RyLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEVGOwogICAgICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IDB4QkY7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gMHhCRDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGxlYWQgPSBjOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobGVhZCkgewogICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEVGOwogICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEJGOwogICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSAweEJEOwogICAgICAgICAgICAgIGxlYWQgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjIDwgMHg4MCkgewogICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSBjOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYyA8IDB4ODAwKSB7CiAgICAgICAgICAgICAgICAgIGJ1Zltwb3MrK10gPSBjID4+IDB4NiB8IDB4QzA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYgKGMgPCAweDEwMDAwKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gYyA+PiAweEMgfCAweEUwOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IGMgPj4gMHgxMiB8IDB4RjA7CiAgICAgICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gYyA+PiAweEMgJiAweDNGIHwgMHg4MDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWZbcG9zKytdID0gYyA+PiAweDYgJiAweDNGIHwgMHg4MDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnVmW3BvcysrXSA9IGMgJiAweDNGIHwgMHg4MDsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcG9zOwogIH0KCiAgLy90eXBlIEFyY2dpc1Jlc3RTb3VyY2VTcGVjaWZpY2F0aW9uID0gYW55Ow0KICB2YXIgZXNyaVBiZkdlb21ldHJ5VHlwZUVudW07DQogIChmdW5jdGlvbiAoZXNyaVBiZkdlb21ldHJ5VHlwZUVudW0pIHsNCiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlUG9pbnQiXSA9IDBdID0gImVzcmlHZW9tZXRyeVR5cGVQb2ludCI7DQogICAgICBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVsiZXNyaUdlb21ldHJ5VHlwZU11bHRpcG9pbnQiXSA9IDFdID0gImVzcmlHZW9tZXRyeVR5cGVNdWx0aXBvaW50IjsNCiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlUG9seWxpbmUiXSA9IDJdID0gImVzcmlHZW9tZXRyeVR5cGVQb2x5bGluZSI7DQogICAgICBlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVsiZXNyaUdlb21ldHJ5VHlwZVBvbHlnb24iXSA9IDNdID0gImVzcmlHZW9tZXRyeVR5cGVQb2x5Z29uIjsNCiAgICAgIGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2VzcmlQYmZHZW9tZXRyeVR5cGVFbnVtWyJlc3JpR2VvbWV0cnlUeXBlTXVsdGlwYXRjaCJdID0gNF0gPSAiZXNyaUdlb21ldHJ5VHlwZU11bHRpcGF0Y2giOw0KICAgICAgZXNyaVBiZkdlb21ldHJ5VHlwZUVudW1bZXNyaVBiZkdlb21ldHJ5VHlwZUVudW1bImVzcmlHZW9tZXRyeVR5cGVOb25lIl0gPSAxMjddID0gImVzcmlHZW9tZXRyeVR5cGVOb25lIjsNCiAgfSkoZXNyaVBiZkdlb21ldHJ5VHlwZUVudW0gfHwgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtID0ge30pKTsKCiAgY2xhc3MgQ29udmVydFBiZiB7DQogICAgICBjb25zdHJ1Y3RvcihwYmZEYXRhKSB7DQogICAgICAgICAgdGhpcy5kYXRhID0gcGJmRGF0YTsNCiAgICAgIH0NCiAgICAgIGFzeW5jIGNvbnZlcnQoKSB7DQogICAgICAgICAgdmFyIF9hOw0KICAgICAgICAgIGNvbnN0IHBiZiQxID0gbmV3IHBiZih0aGlzLmRhdGEpOw0KICAgICAgICAgIGNvbnN0IHBiZkpzb24gPSBwcm90bygpLnJlYWQocGJmJDEpOw0KICAgICAgICAgIC8vIEdldCB0aGUgRmVhdHVyZVJlc3VsdA0KICAgICAgICAgIGlmIChwYmZKc29uLnF1ZXJ5UmVzdWx0ID09PSBudWxsKSB7DQogICAgICAgICAgICAgIC8vY29uc29sZS53YXJuKCdpc3N1ZSB3aXRoIHRoZSByZXN1bHQnLCBwYmZKc29uKTsNCiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVzcG9uc2Uoew0KICAgICAgICAgICAgICAgICAgJ2V4Y2VlZGVkVHJhbnNmZXJMaW1pdCc6IHRydWUsDQogICAgICAgICAgICAgIH0sIFtdKTsNCiAgICAgICAgICB9DQogICAgICAgICAgY29uc3QgZmVhdHVyZVJlc3VsdCA9IHBiZkpzb24ucXVlcnlSZXN1bHQuZmVhdHVyZVJlc3VsdDsNCiAgICAgICAgICAvLyBHZXQgdGhlIGZpZWxkIG5hbWVzDQogICAgICAgICAgY29uc3QgZmllbGRzID0gZmVhdHVyZVJlc3VsdC5maWVsZHMubWFwKChmaWVsZCkgPT4gZmllbGQubmFtZSk7DQogICAgICAgICAgLy8gR2V0IHRoZSB0cmFuc2xhdGlvbiBpbmZvDQogICAgICAgICAgY29uc3QgdHJhbnNsYXRpb24gPSBmZWF0dXJlUmVzdWx0LnRyYW5zZm9ybS50cmFuc2xhdGU7DQogICAgICAgICAgY29uc3Qgc2NhbGUgPSBmZWF0dXJlUmVzdWx0LnRyYW5zZm9ybS5zY2FsZTsNCiAgICAgICAgICBjb25zdCBnZW9tZXRyeVR5cGUgPSBmZWF0dXJlUmVzdWx0Lmdlb21ldHJ5VHlwZTsNCiAgICAgICAgICBjb25zdCBxdWFudGl6ZU9yaWdpblBvc3Rpb24gPSBmZWF0dXJlUmVzdWx0LnRyYW5zZm9ybS5xdWFudGl6ZU9yaWdpblBvc3Rpb247DQogICAgICAgICAgY29uc3Qgc3JpZCA9IChfYSA9IGZlYXR1cmVSZXN1bHQuc3BhdGlhbFJlZmVyZW5jZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLndraWQudG9TdHJpbmcoKTsNCiAgICAgICAgICBjb25zdCBmZWF0dXJlcyA9IGZlYXR1cmVSZXN1bHQuZmVhdHVyZXMubWFwKChmZWF0dXJlKSA9PiB7DQogICAgICAgICAgICAgIC8vIFBhcnNlIGVhY2ggYXR0cmlidXRlDQogICAgICAgICAgICAgIGxldCBhdHRyaWJ1dGVzID0gZmVhdHVyZS5hdHRyaWJ1dGVzDQogICAgICAgICAgICAgICAgICAubWFwKChhdHRyaWJ1dGUsIGluZGV4KSA9PiAoeyAna2V5JzogZmllbGRzW2luZGV4XSwgJ3ZhbHVlJzogYXR0cmlidXRlW2F0dHJpYnV0ZVsndmFsdWVfdHlwZSddXSB9KSkNCiAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoKGEsIGMpID0+IHsNCiAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld09iaiA9IHt9Ow0KICAgICAgICAgICAgICAgICAgbmV3T2JqW2Mua2V5XSA9IGMudmFsdWU7DQogICAgICAgICAgICAgICAgICByZXR1cm4geyAuLi5hLCAuLi5uZXdPYmogfTsNCiAgICAgICAgICAgICAgfSwge30pOw0KICAgICAgICAgICAgICAvLyBQYXJzZSB0aGUgZ2VvbWV0cmllcyBhbmQgY2xlYW4gdXAgdGhlIHF1YW50aXphdGlvbg0KICAgICAgICAgICAgICBsZXQgcmluZ3MgPSBbW1tdXV07DQogICAgICAgICAgICAgIGlmICgoZmVhdHVyZS5nZW9tZXRyeSAhPT0gbnVsbCkpIHsNCiAgICAgICAgICAgICAgICAgIGxldCBjb3VudHMgPSBnZW9tZXRyeVR5cGUgPT09IGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtLmVzcmlHZW9tZXRyeVR5cGVQb2ludCA/IFsxXSA6IChmZWF0dXJlLmdlb21ldHJ5Lmxlbmd0aHMpOw0KICAgICAgICAgICAgICAgICAgLy8gQnJlYWsgaW50byBYIGFuZCBZIHJpbmdzDQogICAgICAgICAgICAgICAgICBsZXQgeCA9IFtdOw0KICAgICAgICAgICAgICAgICAgbGV0IHkgPSBbXTsNCiAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRzLmZvckVhY2goKGNvb3JkLCBpZHgpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ICUgMiA9PT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICB4LnB1c2goY29vcmQpOw0KICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgeS5wdXNoKGNvb3JkKTsNCiAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgIC8vbGV0IHggPSBmZWF0dXJlLmdlb21ldHJ5LmNvb3Jkcy5maWx0ZXIoKF86IG51bWJlciwgaWR4OiBudW1iZXIpID0+IGlkeCAlIDIgPT09IDApOw0KICAgICAgICAgICAgICAgICAgLy9sZXQgeSA9IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRzLmZpbHRlcigoXzogbnVtYmVyLCBpZHg6IG51bWJlcikgPT4gaWR4ICUgMiA9PT0gMSk7DQogICAgICAgICAgICAgICAgICAvLyBkZXppZ3phZyB0aGUgcmluZ3MsIGFuZCBtZXJnZSArIHJlcHJvamVjdCB0aGVtDQogICAgICAgICAgICAgICAgICBsZXQgcmluZ3NYID0gZGVaaWdaYWcoeCwgY291bnRzLCBzY2FsZS54U2NhbGUsIHRyYW5zbGF0aW9uLnhUcmFuc2xhdGUsIGZhbHNlKTsNCiAgICAgICAgICAgICAgICAgIGxldCByaW5nc1kgPSBkZVppZ1phZyh5LCBjb3VudHMsIHNjYWxlLnlTY2FsZSwgdHJhbnNsYXRpb24ueVRyYW5zbGF0ZSwgcXVhbnRpemVPcmlnaW5Qb3N0aW9uID09PSAwKTsNCiAgICAgICAgICAgICAgICAgIC8vIE1lcmdlIHRoZSByaW5ncw0KICAgICAgICAgICAgICAgICAgcmluZ3MgPSBtZXJnZVJpbmdzKHJpbmdzWCwgcmluZ3NZLCBzcmlkKTsNCiAgICAgICAgICAgICAgICAgIC8vcmluZ3MgPSByaW5nc1gubWFwKChyaW5nLCBpKSA9PiByaW5nLm1hcCgoeCwgaikgPT4gW3gsIHJpbmdzWVtpXVtqXV0pKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBsZXQgZ2VvbWV0cnkgPSB7fTsNCiAgICAgICAgICAgICAgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlUG9pbnQnKSB7DQogICAgICAgICAgICAgICAgICBnZW9tZXRyeSA9IHsgJ3gnOiByaW5nc1swXVswXVswXSwgJ3knOiByaW5nc1swXVswXVsxXSB9Ow0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGVsc2UgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlTXVsdGlQb2ludCcpIHsNCiAgICAgICAgICAgICAgICAgIGdlb21ldHJ5ID0geyAncG9pbnRzJzogcmluZ3NbMF0gfTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBlbHNlIGlmIChlc3JpUGJmR2VvbWV0cnlUeXBlRW51bVtnZW9tZXRyeVR5cGVdID09PSAnZXNyaUdlb21ldHJ5VHlwZVBvbHlsaW5lJykgew0KICAgICAgICAgICAgICAgICAgZ2VvbWV0cnkgPSB7IHBhdGhzOiByaW5ncyB9Ow0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGVsc2UgaWYgKGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2dlb21ldHJ5VHlwZV0gPT09ICdlc3JpR2VvbWV0cnlUeXBlUG9seWdvbicpIHsNCiAgICAgICAgICAgICAgICAgIGdlb21ldHJ5ID0geyByaW5nczogcmluZ3MgfTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgICAgICAgJ2dlb21ldHJ5JzogZ2VvbWV0cnksDQogICAgICAgICAgICAgICAgICAnYXR0cmlidXRlcyc6IGF0dHJpYnV0ZXMsDQogICAgICAgICAgICAgIH07DQogICAgICAgICAgfSk7DQogICAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkUmVzcG9uc2UoZmVhdHVyZVJlc3VsdCwgZmVhdHVyZXMpOw0KICAgICAgfQ0KICAgICAgX2J1aWxkUmVzcG9uc2UoZmVhdHVyZVJlc3VsdCwgZmVhdHVyZXMpIHsNCiAgICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgICAnZmVhdHVyZXMnOiBmZWF0dXJlcywNCiAgICAgICAgICAgICAgJ2V4Y2VlZGVkVHJhbnNmZXJMaW1pdCc6IGZlYXR1cmVSZXN1bHQuZXhjZWVkZWRUcmFuc2ZlckxpbWl0LA0KICAgICAgICAgICAgICAnc3BhdGlhbFJlZmVyZW5jZSc6IHsgJ3draWQnOiA0MzI2LCAnbGF0ZXN0V2tpZCc6IDQzMjYgfSwNCiAgICAgICAgICAgICAgJ2dlb21ldHJ5VHlwZSc6IGVzcmlQYmZHZW9tZXRyeVR5cGVFbnVtW2ZlYXR1cmVSZXN1bHQuZ2VvbWV0cnlUeXBlIHx8IDEyN10ucmVwbGFjZSgnVHlwZScsICcnKSwNCiAgICAgICAgICAgICAgJ2hhc00nOiBmZWF0dXJlUmVzdWx0Lmhhc00sDQogICAgICAgICAgICAgICdoYXNaJzogZmVhdHVyZVJlc3VsdC5oYXNaLA0KICAgICAgICAgICAgICAnZ2xvYmFsSWRGaWVsZE5hbWUnOiBmZWF0dXJlUmVzdWx0Lmdsb2JhbElkRmllbGROYW1lDQogICAgICAgICAgfTsNCiAgICAgIH0NCiAgfQoKICBjbGFzcyBHZW9tZXRyaWVzQXRab29tIHsNCiAgICAgIGNvbnN0cnVjdG9yKCkgew0KICAgICAgICAgIC8vIEtlZXBzIHRyYWNrIG9mIHRoZSBnZW9tZXRyaWVzIHRoYXQgaGF2ZSBhbHJlYWR5IGJlZW4gbG9hZGVkDQogICAgICAgICAgdGhpcy5fZ2VvbWV0cmllc0F0Wm9vbSA9IG5ldyBBcnJheSgyNCk7DQogICAgICAgICAgdGhpcy5fbWF4R2VvbWV0cnlab29tID0gMDsNCiAgICAgIH0NCiAgICAgIGFzeW5jIGdldEtleXNBdFpvb20oem9vbSwgbWF4Wm9vbSkgew0KICAgICAgICAgIC8vIERldGVybWluZSB0aGUgbWF4IHpvb20gYmFzZWQgb24gdGhlIHVzZXIgaW5wdXQsIHRoZSBtYXAncyBtYXh6b29tLCBvciB0aGUgbWF4em9vbSB3ZSBoYXZlIGNhY2hlZA0KICAgICAgICAgIG1heFpvb20gPSBtYXhab29tICE9PSB1bmRlZmluZWQgPyBtYXhab29tIDogdGhpcy5fbWF4R2VvbWV0cnlab29tOw0KICAgICAgICAgIGNvbnN0IGdlb21ldHJ5R3JvdXBzID0gW107DQogICAgICAgICAgZm9yIChsZXQgeiA9IChNYXRoLm1pbihtYXhab29tLCB0aGlzLl9tYXhHZW9tZXRyeVpvb20pKTsgeiA+PSB6b29tOyB6LS0pIHsNCiAgICAgICAgICAgICAgaWYgKHRoaXMuX2dlb21ldHJpZXNBdFpvb21bel0gIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgZ2VvbWV0cnlHcm91cHMucHVzaChbLi4udGhpcy5fZ2VvbWV0cmllc0F0Wm9vbVt6XS5rZXlzKCldKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gZ2VvbWV0cnlHcm91cHMuZmxhdCgpOw0KICAgICAgfQ0KICAgICAgdXBkYXRlS2V5QXRab29tKHpvb20sIHByaW1hcnlLZXkpIHsNCiAgICAgICAgICBsZXQgcmV0dXJuVmFsdWUgPSAnYWRkZWQnOw0KICAgICAgICAgIGlmICh0aGlzLl9nZW9tZXRyaWVzQXRab29tW3pvb21dID09PSB1bmRlZmluZWQpDQogICAgICAgICAgICAgIHRoaXMuX2dlb21ldHJpZXNBdFpvb21bem9vbV0gPSBuZXcgTWFwKCk7DQogICAgICAgICAgdGhpcy5fbWF4R2VvbWV0cnlab29tID0gTWF0aC5tYXgodGhpcy5fbWF4R2VvbWV0cnlab29tLCB6b29tKTsNCiAgICAgICAgICBmb3IgKGxldCB6ID0gMDsgeiA8IHpvb207IHorKykgew0KICAgICAgICAgICAgICBpZiAodGhpcy5fZ2VvbWV0cmllc0F0Wm9vbVt6XSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICB0aGlzLl9nZW9tZXRyaWVzQXRab29tW3pdLmRlbGV0ZShwcmltYXJ5S2V5KTsNCiAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlID0gJ3VwZGF0ZWQnOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIHRoaXMuX2dlb21ldHJpZXNBdFpvb21bem9vbV0uc2V0KHByaW1hcnlLZXksIHRydWUpOw0KICAgICAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsNCiAgICAgIH0NCiAgICAgIGFzeW5jIHVwZGF0ZUtleXNBdFpvb20oem9vbSwgcHJpbWFyeUtleXMpIHsNCiAgICAgICAgICByZXR1cm4gcHJpbWFyeUtleXMubWFwKHByaW1hcnlLZXkgPT4gdGhpcy51cGRhdGVLZXlBdFpvb20oem9vbSwgcHJpbWFyeUtleSkpOw0KICAgICAgfQ0KICB9CgogIGNvbnN0IGxpYnJhcmllcyA9IHsNCiAgICAgICdDb252ZXJ0UGJmJzogQ29udmVydFBiZiwNCiAgICAgICdHZW9tZXRyaWVzQXRab29tJzogR2VvbWV0cmllc0F0Wm9vbSwNCiAgICAgICdEZVppZ1phZ0pTT04nOiBEZVppZ1phZ0pTT04NCiAgfTsNCiAgbGV0IHN1YkNsYXNzOw0KICBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHsNCiAgICAgIGNvbnN0IGRhdGEgPSAoZS5kYXRhIHx8IGUpOw0KICAgICAgY29uc3QgcG9zdCA9IChpZCwgZXJyLCByZXMsIHR5cGUpID0+IHsNCiAgICAgICAgICBwb3N0TWVzc2FnZSh7DQogICAgICAgICAgICAgIHR5cGU6IHR5cGUgPyB0eXBlIDogKGVyciA/ICdlcnJvcicgOiAncmVzcG9uc2UnKSwNCiAgICAgICAgICAgICAgaWQ6IGlkLA0KICAgICAgICAgICAgICBtZXNzYWdlOiByZXMsDQogICAgICAgICAgICAgIGVycm9yOiBlcnINCiAgICAgICAgICB9KTsNCiAgICAgIH07DQogICAgICBjb25zdCBjb21tYW5kcyA9IHsNCiAgICAgICAgICAnaW5pdCc6IChtc2cpID0+IHsNCiAgICAgICAgICAgICAgY29uc3QgeyBpZCwgY29tbWFuZCwgbWVzc2FnZSB9ID0gbXNnOw0KICAgICAgICAgICAgICBzdWJDbGFzcyA9IG5ldyBsaWJyYXJpZXNbY29tbWFuZF0oLi4ubWVzc2FnZSk7DQogICAgICAgICAgICAgIC8vIHJldHVybiB0aGUgY2xhc3MnIG1ldGhvZHMNCiAgICAgICAgICAgICAgY29uc3QgZm5zID0gWw0KICAgICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMobGlicmFyaWVzW2NvbW1hbmRdLnByb3RvdHlwZSksDQogICAgICAgICAgICAgICAgICAuLi5PYmplY3Qua2V5cyhzdWJDbGFzcykNCiAgICAgICAgICAgICAgXS5tYXAoa2V5ID0+IFtrZXksIHR5cGVvZiBsaWJyYXJpZXNbY29tbWFuZF0ucHJvdG90eXBlW2tleV1dKQ0KICAgICAgICAgICAgICAgICAgLnJlZHVjZSgoYSwgYykgPT4gKHsgLi4uYSwgLi4ueyBbY1swXV06IGNbMV0gfSB9KSwge30pOw0KICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIGZucywgJ2luaXRfcmVzcG9uc2UnKTsNCiAgICAgICAgICB9LA0KICAgICAgICAgICdnZXQnOiBmdW5jdGlvbiAobXNnKSB7DQogICAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQgfSA9IG1zZzsNCiAgICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdKSB7DQogICAgICAgICAgICAgICAgICBwb3N0KGlkLCB1bmRlZmluZWQsIHN1YkNsYXNzW2NvbW1hbmRdKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgIH0sDQogICAgICAgICAgJ2V4ZWMnOiBmdW5jdGlvbiAobXNnKSB7DQogICAgICAgICAgICAgIGNvbnN0IHsgaWQsIGNvbW1hbmQsIG1lc3NhZ2UgfSA9IG1zZzsNCiAgICAgICAgICAgICAgaWYgKHN1YkNsYXNzICYmIHN1YkNsYXNzW2NvbW1hbmRdICYmIHR5cGVvZiBzdWJDbGFzc1tjb21tYW5kXSA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgICAgICAgY29uc3QgY21kID0gc3ViQ2xhc3NbY29tbWFuZF0NCiAgICAgICAgICAgICAgICAgICAgICAuYXBwbHkoc3ViQ2xhc3MsIG1lc3NhZ2UpOw0KICAgICAgICAgICAgICAgICAgaWYgKCEhY21kICYmIHR5cGVvZiBjbWQudGhlbiA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgICAgICAgICAgIC8vIEl0J3MgYSBwcm9taXNlLCBzbyB3YWl0IGZvciBpdA0KICAgICAgICAgICAgICAgICAgICAgIGNtZA0KICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcG9zdChpZCwgdW5kZWZpbmVkLCByZXMpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZSA9PiBwb3N0KGlkLCBlKSk7DQogICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAvLyBOb3QgYSBwcm9taXNlLCBqdXN0IHJldHVybiBpdA0KICAgICAgICAgICAgICAgICAgICAgIHBvc3QoaWQsIHVuZGVmaW5lZCwgY21kKTsNCiAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgIC8vIEVycm9yDQogICAgICAgICAgICAgICAgICBwb3N0KGlkLCBuZXcgRXJyb3IoYGNvbW1hbmQgIiR7Y29tbWFuZH0iIG5vdCBmb3VuZGApKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgIH07DQogICAgICBpZiAoY29tbWFuZHNbZGF0YS50eXBlXSkgew0KICAgICAgICAgIGNvbW1hbmRzW2RhdGEudHlwZV0oZGF0YSk7DQogICAgICB9DQogIH0pOwoKICBleHBvcnRzLmxpYnJhcmllcyA9IGxpYnJhcmllczsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTsKCiAgcmV0dXJuIGV4cG9ydHM7Cgp9KSh7fSk7Cgo=",m=null,t=!1,o?Z(s,m,t):function(g,I,C){var A;return function(i){return A=A||d(g,I,C),new Worker(A,i)}}(s,m,t));const c=40075016.68557849;function n(g,I){const C=20037508.342789244*g/180;let A=Math.log(Math.tan((90+I)*Math.PI/360))/(Math.PI/180);return A=20037508.342789244*A/180,{x:C,y:A}}function G(g,I=256){return c/(I*(1<<g))}const b=["102100","900913","3857","3587","54004","41001","102113","3785"];function r(g){const I=[Math.min(g[0],g[2]),Math.min(g[1],g[3])],C=[Math.max(g[0],g[2]),Math.max(g[1],g[3])];let A=n(I[0],I[1]),i=n(C[0],C[1]);return{type:"extent",xmin:A.x,ymin:A.y,xmax:i.x,ymax:i.y,spatialReferece:{latestWkid:102100,wkid:3857}}}function V(g,I,C){const A=(g,I)=>{const C=function(g,I){return{lng:180*g/20037508.342789244,lat:360*Math.atan(Math.exp(I*Math.PI/20037508.342789244))/Math.PI-90}}(g,I);return[C.lng,C.lat]};return b.indexOf(C)>-1?g.map(((g,C)=>g.map(((g,i)=>A(g,I[C][i]))))):g.map(((g,C)=>g.map(((g,A)=>[g,I[C][A]]))))}function W(g,I,C,A,i){return I.map(((e,l)=>{let Z=0;return Array(e).fill(void 0).map(((e,d)=>{const o=I.reduce(((g,I,C)=>g+(C<l?I:0)),0),s=g[o+d],m=i?-1:1;let t;return t=0===d?s*m+A/C:s*m+Z,Z=t,t})).map((g=>g*C))}))}var u={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(g,I,C,A,i){var e,l,Z=8*i-A-1,d=(1<<Z)-1,o=d>>1,s=-7,m=C?i-1:0,t=C?-1:1,a=g[I+m];for(m+=t,e=a&(1<<-s)-1,a>>=-s,s+=Z;s>0;e=256*e+g[I+m],m+=t,s-=8);for(l=e&(1<<-s)-1,e>>=-s,s+=A;s>0;l=256*l+g[I+m],m+=t,s-=8);if(0===e)e=1-o;else{if(e===d)return l?NaN:1/0*(a?-1:1);l+=Math.pow(2,A),e-=o}return(a?-1:1)*l*Math.pow(2,e-A)},write:function(g,I,C,A,i,e){var l,Z,d,o=8*e-i-1,s=(1<<o)-1,m=s>>1,t=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,a=A?0:e-1,c=A?1:-1,n=I<0||0===I&&1/I<0?1:0;for(I=Math.abs(I),isNaN(I)||I===1/0?(Z=isNaN(I)?1:0,l=s):(l=Math.floor(Math.log(I)/Math.LN2),I*(d=Math.pow(2,-l))<1&&(l--,d*=2),(I+=l+m>=1?t/d:t*Math.pow(2,1-m))*d>=2&&(l++,d/=2),l+m>=s?(Z=0,l=s):l+m>=1?(Z=(I*d-1)*Math.pow(2,i),l+=m):(Z=I*Math.pow(2,m-1)*Math.pow(2,i),l=0));i>=8;g[C+a]=255&Z,a+=c,Z/=256,i-=8);for(l=l<<i|Z,o+=i;o>0;g[C+a]=255&l,a+=c,l/=256,o-=8);g[C+a-c]|=128*n}},y=h,B=u;function h(g){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(g)?g:new Uint8Array(g||0),this.pos=0,this.type=0,this.length=this.buf.length}h.Varint=0,h.Fixed64=1,h.Bytes=2,h.Fixed32=5;var p,Y=4294967296,w=1/Y,H="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function K(g){return g.type===h.Bytes?g.readVarint()+g.pos:g.pos+1}function R(g,I,C){return C?4294967296*I+(g>>>0):4294967296*(I>>>0)+(g>>>0)}function J(g,I,C){var A=I<=16383?1:I<=2097151?2:I<=268435455?3:Math.floor(Math.log(I)/(7*Math.LN2));C.realloc(A);for(var i=C.pos-1;i>=g;i--)C.buf[i+A]=C.buf[i]}function X(g,I){for(var C=0;C<g.length;C++)I.writeVarint(g[C])}function D(g,I){for(var C=0;C<g.length;C++)I.writeSVarint(g[C])}function N(g,I){for(var C=0;C<g.length;C++)I.writeFloat(g[C])}function F(g,I){for(var C=0;C<g.length;C++)I.writeDouble(g[C])}function S(g,I){for(var C=0;C<g.length;C++)I.writeBoolean(g[C])}function Q(g,I){for(var C=0;C<g.length;C++)I.writeFixed32(g[C])}function v(g,I){for(var C=0;C<g.length;C++)I.writeSFixed32(g[C])}function T(g,I){for(var C=0;C<g.length;C++)I.writeFixed64(g[C])}function k(g,I){for(var C=0;C<g.length;C++)I.writeSFixed64(g[C])}function L(g,I){return(g[I]|g[I+1]<<8|g[I+2]<<16)+16777216*g[I+3]}function f(g,I,C){g[C]=I,g[C+1]=I>>>8,g[C+2]=I>>>16,g[C+3]=I>>>24}function P(g,I){return(g[I]|g[I+1]<<8|g[I+2]<<16)+(g[I+3]<<24)}h.prototype={destroy:function(){this.buf=null},readFields:function(g,I,C){for(C=C||this.length;this.pos<C;){var A=this.readVarint(),i=A>>3,e=this.pos;this.type=7&A,g(i,I,this),this.pos===e&&this.skip(A)}return I},readMessage:function(g,I){return this.readFields(g,I,this.readVarint()+this.pos)},readFixed32:function(){var g=L(this.buf,this.pos);return this.pos+=4,g},readSFixed32:function(){var g=P(this.buf,this.pos);return this.pos+=4,g},readFixed64:function(){var g=L(this.buf,this.pos)+L(this.buf,this.pos+4)*Y;return this.pos+=8,g},readSFixed64:function(){var g=L(this.buf,this.pos)+P(this.buf,this.pos+4)*Y;return this.pos+=8,g},readFloat:function(){var g=B.read(this.buf,this.pos,!0,23,4);return this.pos+=4,g},readDouble:function(){var g=B.read(this.buf,this.pos,!0,52,8);return this.pos+=8,g},readVarint:function(g){var I,C,A=this.buf;return I=127&(C=A[this.pos++]),C<128?I:(I|=(127&(C=A[this.pos++]))<<7,C<128?I:(I|=(127&(C=A[this.pos++]))<<14,C<128?I:(I|=(127&(C=A[this.pos++]))<<21,C<128?I:function(g,I,C){var A,i,e=C.buf;if(i=e[C.pos++],A=(112&i)>>4,i<128)return R(g,A,I);if(i=e[C.pos++],A|=(127&i)<<3,i<128)return R(g,A,I);if(i=e[C.pos++],A|=(127&i)<<10,i<128)return R(g,A,I);if(i=e[C.pos++],A|=(127&i)<<17,i<128)return R(g,A,I);if(i=e[C.pos++],A|=(127&i)<<24,i<128)return R(g,A,I);if(i=e[C.pos++],A|=(1&i)<<31,i<128)return R(g,A,I);throw new Error("Expected varint not more than 10 bytes")}(I|=(15&(C=A[this.pos]))<<28,g,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var g=this.readVarint();return g%2==1?(g+1)/-2:g/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var g=this.readVarint()+this.pos,I=this.pos;return this.pos=g,g-I>=12&&H?function(g,I,C){return H.decode(g.subarray(I,C))}(this.buf,I,g):function(g,I,C){var A="",i=I;for(;i<C;){var e,l,Z,d=g[i],o=null,s=d>239?4:d>223?3:d>191?2:1;if(i+s>C)break;1===s?d<128&&(o=d):2===s?128==(192&(e=g[i+1]))&&(o=(31&d)<<6|63&e)<=127&&(o=null):3===s?(e=g[i+1],l=g[i+2],128==(192&e)&&128==(192&l)&&((o=(15&d)<<12|(63&e)<<6|63&l)<=2047||o>=55296&&o<=57343)&&(o=null)):4===s&&(e=g[i+1],l=g[i+2],Z=g[i+3],128==(192&e)&&128==(192&l)&&128==(192&Z)&&((o=(15&d)<<18|(63&e)<<12|(63&l)<<6|63&Z)<=65535||o>=1114112)&&(o=null)),null===o?(o=65533,s=1):o>65535&&(o-=65536,A+=String.fromCharCode(o>>>10&1023|55296),o=56320|1023&o),A+=String.fromCharCode(o),i+=s}return A}(this.buf,I,g)},readBytes:function(){var g=this.readVarint()+this.pos,I=this.buf.subarray(this.pos,g);return this.pos=g,I},readPackedVarint:function(g,I){if(this.type!==h.Bytes)return g.push(this.readVarint(I));var C=K(this);for(g=g||[];this.pos<C;)g.push(this.readVarint(I));return g},readPackedSVarint:function(g){if(this.type!==h.Bytes)return g.push(this.readSVarint());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readSVarint());return g},readPackedBoolean:function(g){if(this.type!==h.Bytes)return g.push(this.readBoolean());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readBoolean());return g},readPackedFloat:function(g){if(this.type!==h.Bytes)return g.push(this.readFloat());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readFloat());return g},readPackedDouble:function(g){if(this.type!==h.Bytes)return g.push(this.readDouble());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readDouble());return g},readPackedFixed32:function(g){if(this.type!==h.Bytes)return g.push(this.readFixed32());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readFixed32());return g},readPackedSFixed32:function(g){if(this.type!==h.Bytes)return g.push(this.readSFixed32());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readSFixed32());return g},readPackedFixed64:function(g){if(this.type!==h.Bytes)return g.push(this.readFixed64());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readFixed64());return g},readPackedSFixed64:function(g){if(this.type!==h.Bytes)return g.push(this.readSFixed64());var I=K(this);for(g=g||[];this.pos<I;)g.push(this.readSFixed64());return g},skip:function(g){var I=7&g;if(I===h.Varint)for(;this.buf[this.pos++]>127;);else if(I===h.Bytes)this.pos=this.readVarint()+this.pos;else if(I===h.Fixed32)this.pos+=4;else{if(I!==h.Fixed64)throw new Error("Unimplemented type: "+I);this.pos+=8}},writeTag:function(g,I){this.writeVarint(g<<3|I)},realloc:function(g){for(var I=this.length||16;I<this.pos+g;)I*=2;if(I!==this.length){var C=new Uint8Array(I);C.set(this.buf),this.buf=C,this.length=I}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(g){this.realloc(4),f(this.buf,g,this.pos),this.pos+=4},writeSFixed32:function(g){this.realloc(4),f(this.buf,g,this.pos),this.pos+=4},writeFixed64:function(g){this.realloc(8),f(this.buf,-1&g,this.pos),f(this.buf,Math.floor(g*w),this.pos+4),this.pos+=8},writeSFixed64:function(g){this.realloc(8),f(this.buf,-1&g,this.pos),f(this.buf,Math.floor(g*w),this.pos+4),this.pos+=8},writeVarint:function(g){(g=+g||0)>268435455||g<0?function(g,I){var C,A;g>=0?(C=g%4294967296|0,A=g/4294967296|0):(A=~(-g/4294967296),4294967295^(C=~(-g%4294967296))?C=C+1|0:(C=0,A=A+1|0));if(g>=0x10000000000000000||g<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");I.realloc(10),function(g,I,C){C.buf[C.pos++]=127&g|128,g>>>=7,C.buf[C.pos++]=127&g|128,g>>>=7,C.buf[C.pos++]=127&g|128,g>>>=7,C.buf[C.pos++]=127&g|128,g>>>=7,C.buf[C.pos]=127&g}(C,0,I),function(g,I){var C=(7&g)<<4;if(I.buf[I.pos++]|=C|((g>>>=3)?128:0),!g)return;if(I.buf[I.pos++]=127&g|((g>>>=7)?128:0),!g)return;if(I.buf[I.pos++]=127&g|((g>>>=7)?128:0),!g)return;if(I.buf[I.pos++]=127&g|((g>>>=7)?128:0),!g)return;if(I.buf[I.pos++]=127&g|((g>>>=7)?128:0),!g)return;I.buf[I.pos++]=127&g}(A,I)}(g,this):(this.realloc(4),this.buf[this.pos++]=127&g|(g>127?128:0),g<=127||(this.buf[this.pos++]=127&(g>>>=7)|(g>127?128:0),g<=127||(this.buf[this.pos++]=127&(g>>>=7)|(g>127?128:0),g<=127||(this.buf[this.pos++]=g>>>7&127))))},writeSVarint:function(g){this.writeVarint(g<0?2*-g-1:2*g)},writeBoolean:function(g){this.writeVarint(Boolean(g))},writeString:function(g){g=String(g),this.realloc(4*g.length),this.pos++;var I=this.pos;this.pos=function(g,I,C){for(var A,i,e=0;e<I.length;e++){if((A=I.charCodeAt(e))>55295&&A<57344){if(!i){A>56319||e+1===I.length?(g[C++]=239,g[C++]=191,g[C++]=189):i=A;continue}if(A<56320){g[C++]=239,g[C++]=191,g[C++]=189,i=A;continue}A=i-55296<<10|A-56320|65536,i=null}else i&&(g[C++]=239,g[C++]=191,g[C++]=189,i=null);A<128?g[C++]=A:(A<2048?g[C++]=A>>6|192:(A<65536?g[C++]=A>>12|224:(g[C++]=A>>18|240,g[C++]=A>>12&63|128),g[C++]=A>>6&63|128),g[C++]=63&A|128)}return C}(this.buf,g,this.pos);var C=this.pos-I;C>=128&&J(I,C,this),this.pos=I-1,this.writeVarint(C),this.pos+=C},writeFloat:function(g){this.realloc(4),B.write(this.buf,g,this.pos,!0,23,4),this.pos+=4},writeDouble:function(g){this.realloc(8),B.write(this.buf,g,this.pos,!0,52,8),this.pos+=8},writeBytes:function(g){var I=g.length;this.writeVarint(I),this.realloc(I);for(var C=0;C<I;C++)this.buf[this.pos++]=g[C]},writeRawMessage:function(g,I){this.pos++;var C=this.pos;g(I,this);var A=this.pos-C;A>=128&&J(C,A,this),this.pos=C-1,this.writeVarint(A),this.pos+=A},writeMessage:function(g,I,C){this.writeTag(g,h.Bytes),this.writeRawMessage(I,C)},writePackedVarint:function(g,I){I.length&&this.writeMessage(g,X,I)},writePackedSVarint:function(g,I){I.length&&this.writeMessage(g,D,I)},writePackedBoolean:function(g,I){I.length&&this.writeMessage(g,S,I)},writePackedFloat:function(g,I){I.length&&this.writeMessage(g,N,I)},writePackedDouble:function(g,I){I.length&&this.writeMessage(g,F,I)},writePackedFixed32:function(g,I){I.length&&this.writeMessage(g,Q,I)},writePackedSFixed32:function(g,I){I.length&&this.writeMessage(g,v,I)},writePackedFixed64:function(g,I){I.length&&this.writeMessage(g,T,I)},writePackedSFixed64:function(g,I){I.length&&this.writeMessage(g,k,I)},writeBytesField:function(g,I){this.writeTag(g,h.Bytes),this.writeBytes(I)},writeFixed32Field:function(g,I){this.writeTag(g,h.Fixed32),this.writeFixed32(I)},writeSFixed32Field:function(g,I){this.writeTag(g,h.Fixed32),this.writeSFixed32(I)},writeFixed64Field:function(g,I){this.writeTag(g,h.Fixed64),this.writeFixed64(I)},writeSFixed64Field:function(g,I){this.writeTag(g,h.Fixed64),this.writeSFixed64(I)},writeVarintField:function(g,I){this.writeTag(g,h.Varint),this.writeVarint(I)},writeSVarintField:function(g,I){this.writeTag(g,h.Varint),this.writeSVarint(I)},writeStringField:function(g,I){this.writeTag(g,h.Bytes),this.writeString(I)},writeFloatField:function(g,I){this.writeTag(g,h.Fixed32),this.writeFloat(I)},writeDoubleField:function(g,I){this.writeTag(g,h.Fixed64),this.writeDouble(I)},writeBooleanField:function(g,I){this.writeVarintField(g,Boolean(I))}},function(g){g[g.esriGeometryTypePoint=0]="esriGeometryTypePoint",g[g.esriGeometryTypeMultipoint=1]="esriGeometryTypeMultipoint",g[g.esriGeometryTypePolyline=2]="esriGeometryTypePolyline",g[g.esriGeometryTypePolygon=3]="esriGeometryTypePolygon",g[g.esriGeometryTypeMultipatch=4]="esriGeometryTypeMultipatch",g[g.esriGeometryTypeNone=127]="esriGeometryTypeNone"}(p||(p={}));const M={ConvertPbf:class{constructor(g){this.data=g}async convert(){var g;const I=new y(this.data),C=function(){let g={read:function(I,C){return I.readFields(g._readField,{version:"",queryResult:null},C)},_readField:function(I,C,A){1===I?C.version=A.readString():2===I&&(C.queryResult=g.QueryResult.read(A,A.readVarint()+A.pos))},write:function(I,C){I.version&&C.writeStringField(1,I.version),I.queryResult&&C.writeMessage(2,g.QueryResult.write,I.queryResult)},GeometryType:{esriGeometryTypePoint:{value:0,options:{}},esriGeometryTypeMultipoint:{value:1,options:{}},esriGeometryTypePolyline:{value:2,options:{}},esriGeometryTypePolygon:{value:3,options:{}},esriGeometryTypeMultipatch:{value:4,options:{}},esriGeometryTypeNone:{value:127,options:{}}},FieldType:{esriFieldTypeSmallInteger:{value:0,options:{}},esriFieldTypeInteger:{value:1,options:{}},esriFieldTypeSingle:{value:2,options:{}},esriFieldTypeDouble:{value:3,options:{}},esriFieldTypeString:{value:4,options:{}},esriFieldTypeDate:{value:5,options:{}},esriFieldTypeOID:{value:6,options:{}},esriFieldTypeGeometry:{value:7,options:{}},esriFieldTypeBlob:{value:8,options:{}},esriFieldTypeRaster:{value:9,options:{}},esriFieldTypeGUID:{value:10,options:{}},esriFieldTypeGlobalID:{value:11,options:{}},esriFieldTypeXML:{value:12,options:{}}},SQLType:{sqlTypeBigInt:{value:0,options:{}},sqlTypeBinary:{value:1,options:{}},sqlTypeBit:{value:2,options:{}},sqlTypeChar:{value:3,options:{}},sqlTypeDate:{value:4,options:{}},sqlTypeDecimal:{value:5,options:{}},sqlTypeDouble:{value:6,options:{}},sqlTypeFloat:{value:7,options:{}},sqlTypeGeometry:{value:8,options:{}},sqlTypeGUID:{value:9,options:{}},sqlTypeInteger:{value:10,options:{}},sqlTypeLongNVarchar:{value:11,options:{}},sqlTypeLongVarbinary:{value:12,options:{}},sqlTypeLongVarchar:{value:13,options:{}},sqlTypeNChar:{value:14,options:{}},sqlTypeNVarchar:{value:15,options:{}},sqlTypeOther:{value:16,options:{}},sqlTypeReal:{value:17,options:{}},sqlTypeSmallInt:{value:18,options:{}},sqlTypeSqlXml:{value:19,options:{}},sqlTypeTime:{value:20,options:{}},sqlTypeTimestamp:{value:21,options:{}},sqlTypeTimestamp2:{value:22,options:{}},sqlTypeTinyInt:{value:23,options:{}},sqlTypeVarbinary:{value:24,options:{}},sqlTypeVarchar:{value:25,options:{}}},QuantizeOriginPostion:{upperLeft:{value:0,options:{}},lowerLeft:{value:1,options:{}}},SpatialReference:{}};return g.SpatialReference.read=function(I,C){return I.readFields(g.SpatialReference._readField,{wkid:0,lastestWkid:0,vcsWkid:0,latestVcsWkid:0,wkt:""},C)},g.SpatialReference._readField=function(g,I,C){1===g?I.wkid=C.readVarint():2===g?I.lastestWkid=C.readVarint():3===g?I.vcsWkid=C.readVarint():4===g?I.latestVcsWkid=C.readVarint():5===g&&(I.wkt=C.readString())},g.SpatialReference.write=function(g,I){g.wkid&&I.writeVarintField(1,g.wkid),g.lastestWkid&&I.writeVarintField(2,g.lastestWkid),g.vcsWkid&&I.writeVarintField(3,g.vcsWkid),g.latestVcsWkid&&I.writeVarintField(4,g.latestVcsWkid),g.wkt&&I.writeStringField(5,g.wkt)},g.Field={},g.Field.read=function(I,C){return I.readFields(g.Field._readField,{name:"",fieldType:0,alias:"",sqlType:0,domain:"",defaultValue:""},C)},g.Field._readField=function(g,I,C){1===g?I.name=C.readString():2===g?I.fieldType=C.readVarint():3===g?I.alias=C.readString():4===g?I.sqlType=C.readVarint():5===g?I.domain=C.readString():6===g&&(I.defaultValue=C.readString())},g.Field.write=function(g,I){g.name&&I.writeStringField(1,g.name),g.fieldType&&I.writeVarintField(2,g.fieldType),g.alias&&I.writeStringField(3,g.alias),g.sqlType&&I.writeVarintField(4,g.sqlType),g.domain&&I.writeStringField(5,g.domain),g.defaultValue&&I.writeStringField(6,g.defaultValue)},g.Value={},g.Value.read=function(I,C){return I.readFields(g.Value._readField,{string_value:"",value_type:null,float_value:0,double_value:0,sint_value:0,uint_value:0,int64_value:0,uint64_value:0,sint64_value:0,bool_value:!1},C)},g.Value._readField=function(g,I,C){1===g?(I.string_value=C.readString(),I.value_type="string_value"):2===g?(I.float_value=C.readFloat(),I.value_type="float_value"):3===g?(I.double_value=C.readDouble(),I.value_type="double_value"):4===g?(I.sint_value=C.readSVarint(),I.value_type="sint_value"):5===g?(I.uint_value=C.readVarint(),I.value_type="uint_value"):6===g?(I.int64_value=C.readVarint(!0),I.value_type="int64_value"):7===g?(I.uint64_value=C.readVarint(),I.value_type="uint64_value"):8===g?(I.sint64_value=C.readSVarint(),I.value_type="sint64_value"):9===g&&(I.bool_value=C.readBoolean(),I.value_type="bool_value")},g.Value.write=function(g,I){g.string_value&&I.writeStringField(1,g.string_value),g.float_value&&I.writeFloatField(2,g.float_value),g.double_value&&I.writeDoubleField(3,g.double_value),g.sint_value&&I.writeSVarintField(4,g.sint_value),g.uint_value&&I.writeVarintField(5,g.uint_value),g.int64_value&&I.writeVarintField(6,g.int64_value),g.uint64_value&&I.writeVarintField(7,g.uint64_value),g.sint64_value&&I.writeSVarintField(8,g.sint64_value),g.bool_value&&I.writeBooleanField(9,g.bool_value)},g.Geometry={},g.Geometry.read=function(I,C){return I.readFields(g.Geometry._readField,{lengths:[],coords:[]},C)},g.Geometry._readField=function(g,I,C){2===g?C.readPackedVarint(I.lengths):3===g&&C.readPackedSVarint(I.coords)},g.Geometry.write=function(g,I){g.lengths&&I.writePackedVarint(2,g.lengths),g.coords&&I.writePackedSVarint(3,g.coords)},g.esriShapeBuffer={},g.esriShapeBuffer.read=function(I,C){return I.readFields(g.esriShapeBuffer._readField,{bytes:null},C)},g.esriShapeBuffer._readField=function(g,I,C){1===g&&(I.bytes=C.readBytes())},g.esriShapeBuffer.write=function(g,I){g.bytes&&I.writeBytesField(1,g.bytes)},g.Feature={},g.Feature.read=function(I,C){return I.readFields(g.Feature._readField,{attributes:[],geometry:null,compressed_geometry:null,shapeBuffer:null,centroid:null},C)},g.Feature._readField=function(I,C,A){1===I?C.attributes.push(g.Value.read(A,A.readVarint()+A.pos)):2===I?(C.geometry=g.Geometry.read(A,A.readVarint()+A.pos),C.compressed_geometry="geometry"):3===I?(C.shapeBuffer=g.esriShapeBuffer.read(A,A.readVarint()+A.pos),C.compressed_geometry="shapeBuffer"):4===I&&(C.centroid=g.Geometry.read(A,A.readVarint()+A.pos))},g.Feature.write=function(I,C){if(I.attributes)for(var A=0;A<I.attributes.length;A++)C.writeMessage(1,g.Value.write,I.attributes[A]);I.geometry&&C.writeMessage(2,g.Geometry.write,I.geometry),I.shapeBuffer&&C.writeMessage(3,g.esriShapeBuffer.write,I.shapeBuffer),I.centroid&&C.writeMessage(4,g.Geometry.write,I.centroid)},g.UniqueIdField={},g.UniqueIdField.read=function(I,C){return I.readFields(g.UniqueIdField._readField,{name:"",isSystemMaintained:!1},C)},g.UniqueIdField._readField=function(g,I,C){1===g?I.name=C.readString():2===g&&(I.isSystemMaintained=C.readBoolean())},g.UniqueIdField.write=function(g,I){g.name&&I.writeStringField(1,g.name),g.isSystemMaintained&&I.writeBooleanField(2,g.isSystemMaintained)},g.GeometryProperties={},g.GeometryProperties.read=function(I,C){return I.readFields(g.GeometryProperties._readField,{shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},C)},g.GeometryProperties._readField=function(g,I,C){1===g?I.shapeAreaFieldName=C.readString():2===g?I.shapeLengthFieldName=C.readString():3===g&&(I.units=C.readString())},g.GeometryProperties.write=function(g,I){g.shapeAreaFieldName&&I.writeStringField(1,g.shapeAreaFieldName),g.shapeLengthFieldName&&I.writeStringField(2,g.shapeLengthFieldName),g.units&&I.writeStringField(3,g.units)},g.ServerGens={},g.ServerGens.read=function(I,C){return I.readFields(g.ServerGens._readField,{minServerGen:0,serverGen:0},C)},g.ServerGens._readField=function(g,I,C){1===g?I.minServerGen=C.readVarint():2===g&&(I.serverGen=C.readVarint())},g.ServerGens.write=function(g,I){g.minServerGen&&I.writeVarintField(1,g.minServerGen),g.serverGen&&I.writeVarintField(2,g.serverGen)},g.Scale={},g.Scale.read=function(I,C){return I.readFields(g.Scale._readField,{xScale:0,yScale:0,mScale:0,zScale:0},C)},g.Scale._readField=function(g,I,C){1===g?I.xScale=C.readDouble():2===g?I.yScale=C.readDouble():3===g?I.mScale=C.readDouble():4===g&&(I.zScale=C.readDouble())},g.Scale.write=function(g,I){g.xScale&&I.writeDoubleField(1,g.xScale),g.yScale&&I.writeDoubleField(2,g.yScale),g.mScale&&I.writeDoubleField(3,g.mScale),g.zScale&&I.writeDoubleField(4,g.zScale)},g.Translate={},g.Translate.read=function(I,C){return I.readFields(g.Translate._readField,{xTranslate:0,yTranslate:0,mTranslate:0,zTranslate:0},C)},g.Translate._readField=function(g,I,C){1===g?I.xTranslate=C.readDouble():2===g?I.yTranslate=C.readDouble():3===g?I.mTranslate=C.readDouble():4===g&&(I.zTranslate=C.readDouble())},g.Translate.write=function(g,I){g.xTranslate&&I.writeDoubleField(1,g.xTranslate),g.yTranslate&&I.writeDoubleField(2,g.yTranslate),g.mTranslate&&I.writeDoubleField(3,g.mTranslate),g.zTranslate&&I.writeDoubleField(4,g.zTranslate)},g.Transform={},g.Transform.read=function(I,C){return I.readFields(g.Transform._readField,{quantizeOriginPostion:0,scale:null,translate:null},C)},g.Transform._readField=function(I,C,A){1===I?C.quantizeOriginPostion=A.readVarint():2===I?C.scale=g.Scale.read(A,A.readVarint()+A.pos):3===I&&(C.translate=g.Translate.read(A,A.readVarint()+A.pos))},g.Transform.write=function(I,C){I.quantizeOriginPostion&&C.writeVarintField(1,I.quantizeOriginPostion),I.scale&&C.writeMessage(2,g.Scale.write,I.scale),I.translate&&C.writeMessage(3,g.Translate.write,I.translate)},g.FeatureResult={},g.FeatureResult.read=function(I,C){return I.readFields(g.FeatureResult._readField,{objectIdFieldName:"",uniqueIdField:null,globalIdFieldName:"",geohashFieldName:"",geometryProperties:null,serverGens:null,geometryType:0,spatialReference:null,exceededTransferLimit:!1,hasZ:!1,hasM:!1,transform:null,fields:[],values:[],features:[]},C)},g.FeatureResult._readField=function(I,C,A){1===I?C.objectIdFieldName=A.readString():2===I?C.uniqueIdField=g.UniqueIdField.read(A,A.readVarint()+A.pos):3===I?C.globalIdFieldName=A.readString():4===I?C.geohashFieldName=A.readString():5===I?C.geometryProperties=g.GeometryProperties.read(A,A.readVarint()+A.pos):6===I?C.serverGens=g.ServerGens.read(A,A.readVarint()+A.pos):7===I?C.geometryType=A.readVarint():8===I?C.spatialReference=g.SpatialReference.read(A,A.readVarint()+A.pos):9===I?C.exceededTransferLimit=A.readBoolean():10===I?C.hasZ=A.readBoolean():11===I?C.hasM=A.readBoolean():12===I?C.transform=g.Transform.read(A,A.readVarint()+A.pos):13===I?C.fields.push(g.Field.read(A,A.readVarint()+A.pos)):14===I?C.values.push(g.Value.read(A,A.readVarint()+A.pos)):15===I&&C.features.push(g.Feature.read(A,A.readVarint()+A.pos))},g.FeatureResult.write=function(I,C){if(I.objectIdFieldName&&C.writeStringField(1,I.objectIdFieldName),I.uniqueIdField&&C.writeMessage(2,g.UniqueIdField.write,I.uniqueIdField),I.globalIdFieldName&&C.writeStringField(3,I.globalIdFieldName),I.geohashFieldName&&C.writeStringField(4,I.geohashFieldName),I.geometryProperties&&C.writeMessage(5,g.GeometryProperties.write,I.geometryProperties),I.serverGens&&C.writeMessage(6,g.ServerGens.write,I.serverGens),I.geometryType&&C.writeVarintField(7,I.geometryType),I.spatialReference&&C.writeMessage(8,g.SpatialReference.write,I.spatialReference),I.exceededTransferLimit&&C.writeBooleanField(9,I.exceededTransferLimit),I.hasZ&&C.writeBooleanField(10,I.hasZ),I.hasM&&C.writeBooleanField(11,I.hasM),I.transform&&C.writeMessage(12,g.Transform.write,I.transform),I.fields)for(var A=0;A<I.fields.length;A++)C.writeMessage(13,g.Field.write,I.fields[A]);if(I.values)for(A=0;A<I.values.length;A++)C.writeMessage(14,g.Value.write,I.values[A]);if(I.features)for(A=0;A<I.features.length;A++)C.writeMessage(15,g.Feature.write,I.features[A])},g.CountResult={},g.CountResult.read=function(I,C){return I.readFields(g.CountResult._readField,{count:0},C)},g.CountResult._readField=function(g,I,C){1===g&&(I.count=C.readVarint())},g.CountResult.write=function(g,I){g.count&&I.writeVarintField(1,g.count)},g.ObjectIdsResult={},g.ObjectIdsResult.read=function(I,C){return I.readFields(g.ObjectIdsResult._readField,{objectIdFieldName:"",serverGens:null,objectIds:[]},C)},g.ObjectIdsResult._readField=function(I,C,A){1===I?C.objectIdFieldName=A.readString():2===I?C.serverGens=g.ServerGens.read(A,A.readVarint()+A.pos):3===I&&A.readPackedVarint(C.objectIds)},g.ObjectIdsResult.write=function(I,C){I.objectIdFieldName&&C.writeStringField(1,I.objectIdFieldName),I.serverGens&&C.writeMessage(2,g.ServerGens.write,I.serverGens),I.objectIds&&C.writePackedVarint(3,I.objectIds)},g.QueryResult={},g.QueryResult.read=function(I,C){return I.readFields(g.QueryResult._readField,{featureResult:null,Results:null,countResult:null,idsResult:null},C)},g.QueryResult._readField=function(I,C,A){1===I?(C.featureResult=g.FeatureResult.read(A,A.readVarint()+A.pos),C.Results="featureResult"):2===I?(C.countResult=g.CountResult.read(A,A.readVarint()+A.pos),C.Results="countResult"):3===I&&(C.idsResult=g.ObjectIdsResult.read(A,A.readVarint()+A.pos),C.Results="idsResult")},g.QueryResult.write=function(I,C){I.featureResult&&C.writeMessage(1,g.FeatureResult.write,I.featureResult),I.countResult&&C.writeMessage(2,g.CountResult.write,I.countResult),I.idsResult&&C.writeMessage(3,g.ObjectIdsResult.write,I.idsResult)},g}().read(I);if(null===C.queryResult)return this._buildResponse({exceededTransferLimit:!0},[]);const A=C.queryResult.featureResult,i=A.fields.map((g=>g.name)),e=A.transform.translate,l=A.transform.scale,Z=A.geometryType,d=A.transform.quantizeOriginPostion,o=null===(g=A.spatialReference)||void 0===g?void 0:g.wkid.toString(),s=A.features.map((g=>{let I=g.attributes.map(((g,I)=>({key:i[I],value:g[g.value_type]}))).reduce(((g,I)=>{const C={};return C[I.key]=I.value,{...g,...C}}),{}),C=[[[]]];if(null!==g.geometry){let I=Z===p.esriGeometryTypePoint?[1]:g.geometry.lengths,A=[],i=[];g.geometry.coords.forEach(((g,I)=>{I%2==0?A.push(g):i.push(g)})),C=V(W(A,I,l.xScale,e.xTranslate,!1),W(i,I,l.yScale,e.yTranslate,0===d),o)}let A={};return"esriGeometryTypePoint"===p[Z]?A={x:C[0][0][0],y:C[0][0][1]}:"esriGeometryTypeMultiPoint"===p[Z]?A={points:C[0]}:"esriGeometryTypePolyline"===p[Z]?A={paths:C}:"esriGeometryTypePolygon"===p[Z]&&(A={rings:C}),{geometry:A,attributes:I}}));return this._buildResponse(A,s)}_buildResponse(g,I){return{features:I,exceededTransferLimit:g.exceededTransferLimit,spatialReference:{wkid:4326,latestWkid:4326},geometryType:p[g.geometryType||127].replace("Type",""),hasM:g.hasM,hasZ:g.hasZ,globalIdFieldName:g.globalIdFieldName}}},GeometriesAtZoom:class{constructor(){this._geometriesAtZoom=new Array(24),this._maxGeometryZoom=0}async getKeysAtZoom(g,I){I=void 0!==I?I:this._maxGeometryZoom;const C=[];for(let A=Math.min(I,this._maxGeometryZoom);A>=g;A--)void 0!==this._geometriesAtZoom[A]&&C.push([...this._geometriesAtZoom[A].keys()]);return C.flat()}updateKeyAtZoom(g,I){let C="added";void 0===this._geometriesAtZoom[g]&&(this._geometriesAtZoom[g]=new Map),this._maxGeometryZoom=Math.max(this._maxGeometryZoom,g);for(let A=0;A<g;A++)void 0!==this._geometriesAtZoom[A]&&(this._geometriesAtZoom[A].delete(I),C="updated");return this._geometriesAtZoom[g].set(I,!0),C}async updateKeysAtZoom(g,I){return I.map((I=>this.updateKeyAtZoom(g,I)))}},DeZigZagJSON:class{constructor(g,I,C){this.srid="3857",this.features=g,this.transform=I,this.geometryType=C}async convert(){return this.features.map((g=>(g.geometry=this.convertGeometry(g.geometry),g)))}convertGeometry(g){const I=[],C=[],A=[];"esriGeometryPoint"===this.geometryType?(I.push(1),C.push(g.x),A.push(g.y)):"esriGeometryMultipoint"===this.geometryType?g.points.forEach((g=>{I.push(1),C.push(g[0]),A.push(g[1])})):"esriGeometryPolyline"===this.geometryType?g.paths.forEach((g=>{I.push(g.length),g.forEach((g=>{C.push(g[0]),A.push(g[1])}))})):"esriGeometryPolygon"===this.geometryType&&g.rings.forEach((g=>{I.push(g.length),g.forEach((g=>{C.push(g[0]),A.push(g[1])}))}));const i=V(W(C,I,this.transform.scale[0],this.transform.translate[0],!1),W(A,I,this.transform.scale[1],this.transform.translate[1],"upperLeft"===this.transform.originPosition),this.srid);let e={};return"esriGeometryPoint"===this.geometryType?e={x:i[0][0][0],y:i[0][0][1]}:"esriGeometryMultipoint"===this.geometryType?e={points:i[0]}:"esriGeometryPolyline"===this.geometryType?e={paths:i}:"esriGeometryPolygon"===this.geometryType&&(e={rings:i}),e}}};let U;self.addEventListener("message",(g=>{const I=g.data||g,C=(g,I,C,A)=>{postMessage({type:A||(I?"error":"response"),id:g,message:C,error:I})},A={init:g=>{const{id:I,command:A,message:i}=g;U=new M[A](...i);const e=[...Object.getOwnPropertyNames(M[A].prototype),...Object.keys(U)].map((g=>[g,typeof M[A].prototype[g]])).reduce(((g,I)=>({...g,[I[0]]:I[1]})),{});C(I,void 0,e,"init_response")},get:function(g){const{id:I,command:A}=g;U&&U[A]?C(I,void 0,U[A]):C(I,void 0,void 0)},exec:function(g){const{id:I,command:A,message:i}=g;if(U&&U[A]&&"function"==typeof U[A]){const g=U[A].apply(U,i);g&&"function"==typeof g.then?g.then((g=>C(I,void 0,g))).catch((g=>C(I,g))):C(I,void 0,g)}else C(I,new Error(`command "${A}" not found`))}};A[I.type]&&A[I.type](I)}));const x=()=>Math.random().toString(36).substring(2);function z(g,I=[]){return function(){let g=!1;try{g="function"==typeof window.Worker}catch(I){g=!1}return g}()?new O(g,I):new j(g,I)}class O{constructor(g,I=[]){this.initId=x()+"-"+g,this.worker=new a,this.handlers=new Map,this.worker.onmessage=g=>{const I=g.data,C=this.handlers.get(I.id),A=this;if(C){if("response"===I.type&&C.res(I.message),"error"===I.type){const g=I.error||new Error(`Unknown error with ${this.subClass}`);C.rej(g)}"init_response"===I.type&&(this._=Object.keys(I.message).map((g=>{const C=typeof I.message[g];return[g,function(){return C?A.exec(g)(...arguments):A.get(g)}]})).reduce(((g,I)=>({...g,[I[0]]:I[1]})),{}),C.res(this._))}},this.worker.postMessage({type:"init",id:this.initId,command:g,message:I})}onLoad(){return new Promise((g=>{void 0===this._?this.handlers.set(this.initId,{res:g,rej:g}):g(this._)}))}exec(g){const I=this;return function(...C){return new Promise(((A,i)=>{const e=x()+"-"+g;I.handlers.set(e,{res:A,rej:i}),I.worker.postMessage({type:"exec",id:e,command:g,message:[...C]})}))}}get(g){return new Promise(((I,C)=>{const A=x()+"-"+g;this.handlers.set(A,{res:I,rej:C}),this.worker.postMessage({type:"get",id:A,command:g,message:[]})}))}}class j{constructor(g,I=[]){this.subClass=new M[g](...I)}onLoad(){return new Promise((g=>g(this)))}get(g){return new Promise((I=>I(this.subClass[g])))}exec(g){const I=this;return function(...C){return Promise.resolve(I.subClass[g](...C))}}}class E{constructor(g){this._map=g}async fetch(g,I={},C){let A=g.toString();const i=I.body?A.replace(/\??$/,"?")+I.body:A;i.length>2048&&void 0===I.method&&(I.method="POST"),I.method=["POST","GET","PUT"].indexOf((I.method||"").toUpperCase())>-1?(I.method||"").toUpperCase():"GET","GET"===I.method&&(A=i);const e={url:A,method:I.method};return"POST"===I.method&&(I.headers&&(e.headers=I.headers),I.body&&(e.body=I.body.toString())),{arrayBuffer:async()=>(e.type="arrayBuffer",this._getResource(e,C)),json:async()=>(e.type="json",this._getResource(e,C)),text:async()=>(e.type="string",this._getResource(e,C))}}async _getResource(g,I){return new Promise(((C,A)=>{let i=this._map.style.getResource(Math.random().toString(32).substring(2),g,((g,I)=>{g?A(g.toString()):C(I)}));I&&I({cancel:()=>{i.cancel(),A("cancel")}})}))}}const _={where:"1=1",outfields:"*",resultRecordCount:void 0};return function(g){return class extends g.GeoJSONSource{constructor(I,C,A,i){super(I,{type:"geojson",collectResourceTiming:!1},A,i),this._quantizedQuery=!1,this._requestFormat="json",this._geometriesAtZoom=z("GeometriesAtZoom"),this._requests=[],this._sortableFields=[],this._events=new g.Evented,this._liveLayer=!1,this._waitTimes={},this.id=I,this._originalSource={..._,...C};const e=this._originalSource.url.match(/.+?[Feature|Map]Server\/\d{1,}/);if(!e)throw new Error("ArcGisRest URL is invalid "+this._originalSource.url);this._originalSource.url=e[0],window.source=this}onAdd(g){this.map=g,this._asyncLoad(g).then((()=>super.load()))}async _asyncLoad(g){const I=new URL(this._originalSource.url);I.searchParams.append("f","json"),this._originalSource.token&&I.searchParams.append("token",this._originalSource.token);const C=new E(g),A=await(await C.fetch(I)).json();if(A.error)return console.error("ArcGIS Error",A.error),!1;const i=A.maxRecordCount||500,e=(A.supportedQueryFormats||"").toLowerCase().replace(/\s/g,"").split(",").indexOf("pbf")>-1;this._requestFormat=e?"pbf":"json",this._quantizedQuery=!0===A.supportsCoordinatesQuantization&&("esriGeometryPolygon"===A.geometryType||"esriGeometryPolyline"===A.geometryType),A.fields&&(this._sortableFields=A.fields.filter((g=>["esriFieldTypeString","esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeInteger","esriFieldTypeOID","esriFieldTypeSingle","esriFieldTypeSmallInteger"].indexOf(g.type)>-1&&-1===g.name.indexOf("()")&&-1===(g.alias||"").indexOf("()"))).map((g=>g.name))),A.indexes&&(this.promoteId=A.indexes.filter((g=>!0===g.isUnique&&g.fields&&this._sortableFields.indexOf(g.fields)>-1)).map((g=>g.fields))[0]),A.fields&&(this._primaryKeyType=A.fields.filter((g=>g.name===this.promoteId)).map((g=>["esriFieldTypeDouble","esriFieldTypeDate","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeInteger","esriFieldTypeOID","esriFieldTypeSingle","esriFieldTypeSmallInteger"].indexOf(g.type)>-1?"number":"string"))[0]),this._originalSource.resultRecordCount=(this._originalSource.resultRecordCount||1/0)<i?this._originalSource.resultRecordCount:i,this.setData({type:"FeatureCollection",features:[]}),this._events.on("data",(g=>this.drawMapData(g.json,g.zoom))),this.loadMapData(g),g.on("moveend",(()=>this._liveLayer&&this._waitEvent("redrawMap",100))),this._events.on("redrawMap",(()=>this.loadMapData(g)))}loadTile(g,I){this._liveLayer||(this._liveLayer=!0,this._waitEvent("redrawMap",1e3)),super.loadTile(g,I)}async loadMapData(g,I){if(void 0===(g=void 0===g?this.map:g))throw new Error("Source Data (Source ID: "+this.id+") could not be loaded");console.log("LOADING");const C=this._quantizedQuery?Math.floor(this.map.getZoom()):this.map.getMaxZoom();let A=this._originalSource.where;const i={where:A};if(this.promoteId){const e=n((I=I||[g.getBounds().getWest(),g.getBounds().getSouth(),g.getBounds().getEast(),g.getBounds().getNorth()])[0],I[1]),l=n(I[2],I[3]),Z=[e.x,e.y,l.x,l.y],d=await this._geometriesAtZoom.exec("getKeysAtZoom")(C);i.geometry=Z.join(","),i.geometryType="esriGeometryEnvelope",i.inSR="3857";const o=g=>"string"===this._primaryKeyType?`'${g}'`:g;d.length&&(i.where=`(${A}) AND "${this.promoteId}" NOT IN (${d.map((g=>o(g))).join(",")})`)}this._requests.forEach((g=>g.cancel())),this._queryFeatures(this._originalSource.url,i,0,(g=>this._requests.push(g)),g,C),this._liveLayer=!1}async drawMapData(g,I){const C=this._esriJsonToFeatures(g),A=C.map((g=>g.properties[this.promoteId])),i=await this._geometriesAtZoom.exec("updateKeysAtZoom")(I,A),e={add:i.map(((g,I)=>{if("added"===g)return C[I]})).filter((g=>void 0!==g)),update:i.map(((g,I)=>{if("updated"===g)return C[I].geometry,{id:A[I],newGeometry:C[I].geometry}})).filter((g=>void 0!==g))};if(e.update.length||e.add.length){this.updateData;{const g=this._data.features,I=g.map((g=>g.properties[this.promoteId]));for(let C=0;C<e.update.length;C++){let A=I.indexOf(e.update[C].id);A>-1&&(g[A].geometry=e.update[C].newGeometry)}for(let I=0;I<e.add.length;I++)g.push(e.add[I]);this.setData(this._data)}}}async _queryFeatures(g,I,C,A,i,e){if(void 0===(i=void 0===i?this.map:i))throw new Error("Source Data (Source ID: "+this.id+") could not be loaded");const l=Array.isArray(this._originalSource.outfields)?this._originalSource.outfields.map((g=>`"${g}"`)).join(","):"*",Z=this._quantizedQuery?JSON.stringify(function(g,I=256){return{mode:"view",originPosition:"upperLeft",tolerance:G(g,I),extent:r([-180,-85.06,180,85.06])}}(e,this.tileSize)):"",d={where:this._options.where,spatialRel:"esriSpatialRelIntersects",outFields:l,returnGeometry:!0,returnTrueCurves:!1,outSR:this._quantizedQuery||"pbf"===this._requestFormat?"3857":"4326",returnIdsOnly:!1,returnCountOnly:!1,returnZ:!1,returnM:!1,returnDistinctValues:!1,returnExtentOnly:!1,featureEncoding:"esriDefault",orderByFields:this._sortableFields.map((g=>`"${g}"`)).join(","),resultOffset:void 0!==C?C:0,resultRecordCount:this._originalSource.resultRecordCount,quantizationParameters:Z,f:this._requestFormat,...I},o=new E(i),s=new URL(g);Object.keys(d).map((g=>s.searchParams.append(g,d[g].toString())));const m=o.fetch(g+"/query",{body:s.search.replace(/^\?/,""),headers:{"content-type":"application/x-www-form-urlencoded"}},(g=>A&&A(g))),t=await await m;let a={features:[],exceededTransferLimit:!1};try{if("pbf"===d.f){const g=z("ConvertPbf",[await t.arrayBuffer()]);a=await g.exec("convert")()}else if(a=await t.json(),this._quantizedQuery){const g=z("DeZigZagJSON",[a.features,a.transform,a.geometryType]),I=await g.exec("convert")();a.spatialReference={wkid:4326},a.features=I}}catch(g){return void("cancel"!==g&&console.error("Error with request",g))}a&&a.features.length&&this._events.fire("data",{json:a,zoom:e}),!0===a.exceededTransferLimit&&this._queryFeatures(g,I,(C||0)+a.features.length,A,i,e)}_esriJsonToFeatures(g){if(-1===Object.keys({esriGeometryPoint:"Point",esriGeometryMultipoint:"MultiPoint",esriGeometryLine:"LineString",esriGeometryPolyline:"MultiLineString",esriGeometryPolygon:"MultiPolygon"}).indexOf(g.geometryType))throw new Error("Geometry "+g.geometryType+" not supported");return g.features.map((I=>(4326!==(g.spatialReference.latestWkid||g.spatialReference.wkid)&&console.warn("Unspported Projection ("+(g.spatialReference.latestWkid||g.spatialReference.wkid)+"), some data may not display correctly"),{type:"Feature",properties:I.attributes,geometry:i(I.geometry)})))}_waitEvent(g,I=100){console.log("Called",g,I),this._waitTimes[g]=(this._waitTimes[g]||0)+I,setTimeout((()=>{void 0!==this._waitTimes[g]&&(this._waitTimes[g]=this._waitTimes[g]-I,this._waitTimes[g]<=0&&(this._waitTimes[g]=0,this._events.fire(g)))}),I)}}}}));
//# sourceMappingURL=maplibre-gl-arcgis-rest-source.min.js.map
